<!DOCTYPE html>
<html lang="{{ g.locale }}">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="Description" content="{% block description %}{% trans %}DataViva is opening up data for the entire formal sector of the Brazilian economy{% endtrans %} {% trans %}through more than 100 million interactive visualizations.{% endtrans %}{% endblock %}">

    <!-- Facebook Properties -->
    <meta property="og:image" content="http://www.dataviva.info/static/img/facebook.jpg" />

    <title>
      DataViva {% block title %}{% endblock %}
    </title>
    <link rel="shortcut icon" href="/static/img/favicon.ico?v=10">

    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/styles.reset.css" />
    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/styles.general.css" />
    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/styles.inputs.css" />
    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/styles.grid.css" />
    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/styles.nav.css" />
    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/styles.icons.css" />
    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/utils.selector.css" />
    <link type="text/css" rel="stylesheet" media="all" href="{{g.s3_host}}/static/css/libs/font-awesome/css/font-awesome.min.css" />
    <!-- <link type="text/css" rel="stylesheet" media="all" href="/static/css/libs/d3plus.css" /> -->

    <script src="{{g.s3_host}}/static/js/libs/ios-orientationchange-fix.js"></script>
    <script src="{{g.s3_host}}/static/js/libs/localforage.js"></script>
    <script src="{{g.s3_host}}/static/js/libs/modernizr.custom.js"></script>
    <script src="{{g.s3_host}}/static/js/libs/d3.min.js"></script>
    <script src="{{g.s3_host}}/static/js/libs/d3plus{% if g.production %}.min{% endif %}.js"></script>
    <script src="{{g.s3_host}}/static/js/libs/leon.js"></script>
    <script src="{{g.s3_host}}/static/js/libs/moment.min.js"></script>
    <script>moment.lang("{{g.locale}}")</script>
    <script src="/static/js/modules/embed/utils.dataviva.js"></script>
    <script src="/static/js/modules/embed/utils.general.js"></script>
    <script src="{{g.s3_host}}/static/js/plugins/jspdf/FileSaver.js"></script>
    <script src="{{g.s3_host}}/static/js/plugins/jspdf/jspdf.js"></script>
    <script src="{{g.s3_host}}/static/js/plugins/jspdf/addimage.js"></script>
    <script type="text/javascript" src="{{g.s3_host}}/static/js/libs/jquery-2.1.1.js"></script>

    <link type="text/css" rel="stylesheet" media="all" href="/static/css/modules/embed/styles.apps.css" />
    <script>var redirect = false</script>

    <!--[if lt IE 9]>
      <script>redirect = true</script>
    <![endif]-->

    <script>
      if(d3plus.ie && redirect) window.location = "/upgrade/"
      dataviva.language = "{{ g.locale }}";
      dataviva.dictionary = {{ g.dictionary|safe }};
      dataviva.attr_version = {{ g.attr_version|safe }};
      dataviva.s3_host = "{{ g.s3_host }}"
    </script>

  </head>
  <body{% if g.page_type %} class="{{g.page_type}}"{% endif %}>

      <div id="mask" class="loading"></div>

      <div id="settings">

        <a id="refresh" class="leon button square alt_tooltip" onclick="app.start()" alt="{% trans %}Refresh the Visualization{% endtrans %}"><i class="fa fa-refresh"></i></a>
        <a id="file" class="leon button square alt_tooltip" onclick="builder.selector(this.id)" alt="{% trans %}Download this Visualization{% endtrans %}"><i class="fa fa-save"></i></a>
        <a id="starred" class="leon button square alt_tooltip" onclick="app.star()" alt="{% trans %}Save this Visualization{% endtrans %}"><i id="status_{{starred}}" class="{% if starred == 1 %}fa fa-star{% else %}fa fa-star-o{% endif %}"></i></a>
        <a id="share" class="leon button square alt_tooltip" onclick="builder.selector(this.id)" alt="{% trans %}Share/Embed{% endtrans %}"><i class="fa fa-share"></i></a>
        <!-- <a id="help" class="leon button square alt_tooltip" onclick="builder.selector(this.id)" alt="{% trans %}Show Visualization Tutorial{% endtrans %}"><i class="fa fa-question-circle"></i></a> -->

        <a id="controls_toggle" class="leon button square alt_tooltip" onclick="builder.controls()" alt="{% trans %}Show/Hide Controls{% endtrans %}"><i class="fa fa-cogs"></i></a>

      </div>

      <div id="app"></div>

      <div id="controls"></div>

      <!-- Hidden <FORM> to submit the SVG data to the server, which will convert it
           to SVG/PDF/PNG downloadable file. -->
      <form id="svgform" action="/{{g.locale}}/embed/download/" method="post">
          {{ form.hidden_tag() }}
      </form>
    
    <script type="text/javascript">

      if (!window.location.origin) {
        window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port: '');
      }

      dataviva.color = "{{ g.color }}";
      dataviva.page = "{{ g.page_type }}";

      d3.selectAll(".alt_tooltip")
        .on(d3plus.client.pointer.over,function(){
          dataviva.ui.tooltip("alt_tooltip",this)
        })
        .on(d3plus.client.pointer.out,function(){
          dataviva.ui.tooltip("alt_tooltip",false)
        })

      function login() {
        var width = 600,
            height = 400,
            left = window.screenX+(window.innerWidth/2)-(width/2),
            top = window.screenY+(window.innerHeight/2)-(height/2)
        window.open('/user/login/','','width='+width+',height='+height+',\
                                        left='+left+',top='+top+',\
                                        scrollbars=no,resizable=no,\
                                        location=no,menubar=no,toolbar=no')
      }

    </script>

  <script src="{{g.s3_host}}/static/js/libs/topojson.js"></script>
  <script src="{{g.s3_host}}/static/js/libs/queue.min.js"></script>
  <script src="/static/js/modules/embed/utils.selector.js"></script>

  <script>
  // Handling Cookies
  function getCookie( name ) {
    var parts = document.cookie.split(name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
  }

  function expireCookie( cName ) {
    document.cookie =
      encodeURIComponent( cName ) +
      "=deleted; expires=" +
      new Date( 0 ).toUTCString();
  }


  var downloadTimer;
  var attempts = 30;

  // Starts de verification if download is finished
  function checkDownloadIsDone() {
    var token = document.getElementById("downloadToken").value;
    downloadTimer = window.setInterval( function() {
        downloadToken = new Date().getTime();
        //console.log(getCookie("downloadToken"));
        //console.log({tokennow: token, cookitoken: downloadToken})
        if( (token < downloadToken) || (attempts == 0) ) {
          //downloadDone();
        }

        attempts--;
    }, 1000 );
  }

    // Destrioy verification and hide the popover
  function downloadDone() {
    dataviva.popover.hide("#popover")
    window.clearInterval( downloadTimer );
    expireCookie( "downloadToken" );
  }
  </script>

  <script type="text/javascript">

    var year_range = {{ year_range|safe }};

    var loading = new dataviva.ui.loading("body")
    loading.color("#ffffff")

    loading.text("Initializing Visualization").show()

    d3.select("#mask").remove()

    // Check to see if parent window element is of same origin
    try {
      var same_origin = window.parent.location.host == window.location.host;
    }
    catch (e) {
      var same_origin = false
    }

    // App Data Formatting
    var format = {
      "occugrid": "occugrid",
      "compare": "compare",
      "geo_map": "default",
      "scatter": "default",
      "network": "default",
      "rings": "default",
      "tree_map": "default",
      "stacked": "default",
      "line": "default",
      "box": "default",
      "bar": "hist"
    }

    // Get various depth levels
    var depths = {
      "cnae": dataviva.depths("cnae"),
      "cbo": dataviva.depths("cbo"),
      "hs": dataviva.depths("hs"),
      "bra": dataviva.depths("bra"),
      "wld": dataviva.depths("wld"),
      "university": dataviva.depths("university"),
      "course_hedu": dataviva.depths("course_hedu"),
      "course_sc": dataviva.depths("course_sc")
    }

    // Create Filter Selector
    var selector = Selector()

    dataviva.popover.create({
      "id": "popover",
      "width": 600,
      "height": "80%"
    })

    leon("#app_select")

    // Hide builder button while in builder
    if (same_origin && parent.location.href.indexOf("builder") >= 0) {
      d3.select("#advanced").remove();
    }

    function open_builder() {
      var new_url = window.location.href.replace("embed", "builder");
      app.redirect(new_url);
    }

    /*******************************/
    /* App Functions and Variables */
    /*******************************/

    var last_app = null;
    window.app = {};
    app.build = null;
    app.url = "{{ current_build.url() }}";
    app.data = {};
    app.ecis = {};
    app.networks = {};
    app.coords = {};
    app.attrs = {};
    app.vars = {{ global_vars|safe }};
    app.solos = [];
    app.filters = [];
    app.first_load = false;

    if (app.vars.builder == "false") {
      app.vars.controls = "false"
      d3.select("#controls_toggle").remove()
    }

    // Set the max-width for the builder div and app_title
    app.title_width = window.innerWidth - 20
    app.title_width -= d3.select("#settings").node().offsetWidth+10

    app.title_height = d3.select("#settings").node().offsetHeight

    app.font = null
    var fonts = ["HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", "Helvetica", "Arial", "sans-serif"]
    fonts.forEach(function(font){
      if (d3plus.font.validate(font) && !app.font) app.font = font
    })

    // app.loader_style = {
    //   "color": "#888",
    //   "font-size": "16px",
    //   "margin-top": "-11px",
    //   "text-shadow": "0px 0px 6px #efefef"
    // }

    var filterIndex = {
      "hs": 3,
      "wld": 4,
      "cnae": 3,
      "cbo": 4,
      "bra": 2,
      "bra_s": 2,
      "bra_r": 2,
      "university": 3,
      "course_hedu": 4,
      "school": 3,
      "course_sc": 4
    }

    var cleanAttrs = function(d, o) {
      var n = app.nesting(o), ret_obj = {};
      var attr_copy = d3plus.util.copy(d.data);
      for (var i = 0; i < n.length; i++) {
        var level = n[i];
        ret_obj[level] = attr_copy.reduce(function(obj, a) {
          if (level === "school_type_id") {
            if (!(a.school_type_id in obj)) {
              obj[a.school_type_id] = {"color": a.color, "name": a.school_type, "icon": "/static/img/icons/school/school_"+a.school_type_id.toLowerCase()+".png"};
            }
          }
          else {
            var d = level.split("_");
            d = parseFloat(d[d.length-1]);
            if (d === a.id.length) {
              a[o+"_id"] = a.id;
              a[o+"_display"] = dataviva.displayID(a.id,o);
              // a.icon = dataviva.icon(a.id,o);
              delete a.export_val;
              delete a.import_val;
              delete a.enrolled;
              delete a.num_jobs;
              delete a.school_type;
              obj[a.id] = a;
            }
          }
          return obj;
        }, {});
      }
      return ret_obj;
    }

    var createRecs = function(html, arr) {
      arr.forEach(function(a){
        if ("app" in a) {
          html += "<a id='"+a.url+"' class='help short icon "
          html += a.app.type+"' ";
          html += "onclick='app.start(this.id)'>";
        }
        else {
          html += "<a id='"+a.url+"' class='decision short icon "
          html += a.type+"' ";
          html += "onclick='app.redirect(this.id)'>";
        }
        html += a.title;
        html += "</a>";
      })
      return html;
    }

    app.timeURL = function(t) {

      if (!t) t = app.years;
      else if (typeof t === "string") t = t.split("_");
      else if (!(t instanceof Array)) t = [t];

      function url_format(d) {
        return d.constructor === Date ? app.timeFormat(d) : d;
      }
      var ret = url_format(t[0]);
      if (t.length > 1) ret += "_"+url_format(t[1]);

      return ""+ret;

    }

    function string2date(s) {
      s = s.split("-");
      var m = 1;
      if (s.length == 2 && s[1] !== "0") m = s[1];
      var y = s[0];
      return new Date(m+"/01/"+y)
    }

    function time2range(t) {
      var date_extent = t.map(function(y, i){
        y = string2date(y);
        if (i === 0) return y;
        if (app.monthly) return new Date(y.setMonth(y.getMonth()+1))
        return new Date(y.setFullYear(y.getFullYear()+1))
      })
      if (date_extent.length === 1) return date_extent;
      var date_range = [];
      var i = new Date(date_extent[0]);
      while (i < date_extent[1]) {
        date_range.push(i);
        i = new Date(i);
        if (app.monthly) i.setMonth(i.getMonth()+1);
        else i.setFullYear(i.getFullYear()+1);
      }
      return date_range;
    }

    app.title_update = function(range) {

      function parse_date(s) {
        if (s.constructor === Date) {
          if (app.monthly) {
            return dataviva.dictionary["month_"+(s.getMonth()+1)]+" "+s.getFullYear();
          }
          else {
            return ""+s.getFullYear();
          }
        }
        if (typeof s === "string") {
          if (s.indexOf("-") > 0) {
            var y = s.split("-")[0];
            var m = s.split("-")[1];
            if (m !== "0") return dataviva.dictionary["month_"+m]+" "+y;
          }
          return s;
        }
        else {
          return ""+s;
        }
      }

      if (!range) {
        range = app.vars.year;
        if (!range) range = app.years;
        else range = range.split("_");
      }
      else if (!range.length) {
        range = app.years;
      }
      else if (range.length === 0) {
        var viztime = app.viz.data(Object).time
        range = viztime ? d3.extent(viztime.values) : app.years;
      }
      else if (range.length > 1) {
        range = d3.extent(range);
      }
      app.vars.year = app.timeURL(range);
      r = parse_date(range[0]);
      if (range.length > 1) r += "-" + parse_date(range[1]);
      range = r;

      if (app.build.app.type == "scatter") {
        var yval = [];
        if (app.vars.year.indexOf("_") < 0 &&
            app.ecis[app.build.data_url] && app.vars.y == "pci") {
          yval = [{
            "position": app.ecis[app.build.data_url][app.vars.year],
            "text": dataviva.format.text("eci")
          }];
        }
        app.viz.y({"lines": yval})
      }

      function format_title(title) {

        var depth = depth = app.viz.id();
        if (app.build.output_attr === "bra" && depth !== "id") {

          var words = title.split(" ");

          var new_depth = dataviva.dictionary[depth];
          var old_depth = dataviva.dictionary[last_depth];
          var index = words.indexOf(old_depth);

          if (index >= 0) words[index] = new_depth;
          else {
            new_depth = dataviva.dictionary[depth+"_plural"];
            old_depth = dataviva.dictionary[last_depth+"_plural"];
            index = words.indexOf(old_depth);
            if (index >= 0) words[index] = new_depth;
          }

          title = words.join(" ");
          last_depth = depth;

        }

        if (app.build.dataset === "ei") {

          var value = dataviva.dictionary[app.vars.size.split("_")[0]],
              purch = dataviva.dictionary.purchase,
              trans = dataviva.dictionary.transfer;

          if (title.indexOf(purch) >= 0) title = title.replace(purch, value);
          else if (title.indexOf(trans) >= 0) title = title.replace(trans, value);

        }
        else if (app.build.dataset === "secex") {

          var val = false;
          if (app.vars.size) val = app.vars.size;
          else if (app.vars.y) val = app.vars.y;
          else if (app.vars.axes) val = app.vars.axes;
          else val = "export_val";

          val = val.slice(0,6)+"s";

          var match = false;
          var exp = dataviva.dictionary.exports;
          var imp = dataviva.dictionary.imports;

          if (title.indexOf(imp+"/"+exp) === 0) var match = imp+"/"+exp;
          else if (title.indexOf(imp) === 0) var match = imp;
          else if (title.indexOf(exp) === 0) var match = exp;
          if (match) {
            title = title.replace(match, dataviva.dictionary[val]);
          }
          else {
            var orig = dataviva.dictionary.origin;
            var dest = dataviva.dictionary.destination;
            if (title.indexOf(orig+"/"+dest) === 0) var match = orig+"/"+dest;
            else if (title.indexOf(orig) === 0) var match = orig;
            else if (title.indexOf(dest) === 0) var match = dest;
            if (match) {
              val = val === "exports" ? dest : orig;
              title = title.replace(match, val)
            }
            else {
              var orig = dataviva.dictionary.origins;
              var dest = dataviva.dictionary.destinations;
              if (title.indexOf(orig+"/"+dest) === 0) var match = orig+"/"+dest;
              else if (title.indexOf(orig) === 0) var match = orig;
              else if (title.indexOf(dest) === 0) var match = dest;
              if (match) {
                val = val === "exports" ? dest : orig;
                title = title.replace(match, val)
              }
            }
          }
        }

        if (title.indexOf("(") < 0) {
          title += " ("+range+")";
        }
        else {
          title = title.replace(/\(.*?\)/, "("+range+")");
        }

        return title;

      }
      
      app.build.title = format_title(app.build.title);
      app.viz.title(app.build.title);
      required_bras();
      builder.url();

      if (same_origin && window.frameElement) {
        var message = {
          "id": window.frameElement.id,
          "title": format_title(app.build.slug),
          "app": app.build.app.type,
          "build": app.build
        };
        if (same_origin && window.parent.update_titles) window.parent.update_titles(message)
      }
    }

    app.html = {
      "callback": function(data) {

        var html_return = "";

        if ("custom" in data) {
          var p = data.custom;
          html_return += "<a id='"+p.url+"' class='decision icon "
          html_return += p.app.type + "' ";
          html_return += "onclick='app.start(this.id)'>";
          html_return += p.title;
          html_return += "</a><br>";
        }
        else if ("profile" in data) {
          var p = data.profile;
          html_return += "<br><a id='"+p.url+"' class='decision icon "
          html_return += app.build.output_attr + "' ";
          html_return += "onclick='app.redirect(this.id)'>";
          html_return += p.title;
          html_return += "</a><br>";
        }

        if ("crosswalk" in data && data.crosswalk.length) {
          html_return += "<div class='title'>"+dataviva.format.text("crosswalk_"+app.build.output_attr)+"</div>";
          html_return = createRecs(html_return, data.crosswalk);
        }

        if ("builds" in data && data.builds.length) {
          html_return += "<div class='title'>"+dataviva.format.text("related_apps")+"</div>";
          html_return = createRecs(html_return, data.builds);
        }
        loading.hide();
        return html_return;
      },
      "url": function(id) {
        var rec_url = app.build.url;
        if (id.constructor !== Array) {
          rec_url = app.build.url.split("/");
          rec_url[filterIndex[app.build.output]] = id;
          rec_url = rec_url.join("/")
        }
        loading.text(dataviva.dictionary.wait).show();
        return "/{{g.locale}}/embed/recommend/"+rec_url+location.search;
      }
    }

    app.tooltip = {"short": {

      "":[],
      "basics":[],
      "calculations":[]

      }, "long": {

      "":[],
      "basics":[
        "wage",
        "wage_avg",
        "wage_avg_bra",
        "num_jobs",
        "num_est",
        "num_jobs_est",

        "export_val",
        "export_kg",
        "export_val_kg",

        "import_val",
        "import_kg",
        "import_val_kg",

        "enrolled",
        "students",
        "graduates",
        "entrants",
        "classes",
        "enrolled_classes",
        "age",

        "purchase_value",
        "transfer_value"

      ],
      "calculations":[
        "elsewhere",
        "required",
        "importance",
        "eci",
        "pci",
        "bra_diversity",
        "bra_diversity_eff",
        "cnae_diversity",
        "cnae_diversity_eff",
        "cbo_diversity",
        "cbo_diversity_eff",
        "hs_diversity",
        "hs_diversity_eff",
        "wld_diversity",
        "wld_diversity_eff",
        "rca",
        "rca_wld",
        "distance",
        "distance_wld",
        "opp_gain",
        "opp_gain_wld"
      ],
      "growth":[
        "wage_growth",
        "wage_growth_5",
        "num_emp_growth",
        "num_emp_growth_5",

        "export_val_growth",
        "export_val_growth_5",
        "import_val_growth",
        "import_val_growth_5",

        "enrolled_growth",
        "graduates_growth"
      ]

        }}

    for (g in app.tooltip.long) {
      var additionals = []
      app.tooltip.long[g].forEach(function(t){
        additionals.push("cp_bra_0_"+t)
        additionals.push("cp_bra_1_"+t)
      })
      app.tooltip.long[g] = app.tooltip.long[g].concat(additionals)
    }

    var averages = {
          "eci": "mean",
          "pci": "mean",
          "bra_diversity": "mean",
          "bra_diversity_eff": "mean",
          "cnae_diversity": "mean",
          "cnae_diversity_eff": "mean",
          "cbo_diversity": "mean",
          "cbo_diversity_eff": "mean",
          "hs_diversity": "mean",
          "hs_diversity_eff": "mean",
          "wld_diversity": "mean",
          "wld_diversity_eff": "mean",
          "rca": "mean",
          "rca_wld": "mean",
          "distance": "mean",
          "distance_wld": "mean",
          "opp_gain": "mean",
          "opp_gain_wld": "mean",
          "num_jobs_est": "mean",
          "wage_avg": function(d) {
            var t = d3.sum(d, function(p){ return p.wage; });
            if (!t) return null;
            return t/d3.sum(d, function(p){ return p.num_jobs; });
          },
          "wage_avg_bra": "mean",
          "wage_growth": "mean",
          "wage_growth_5": "mean",
          "age": "mean",
          "enrolled_classes": function(d) {
            var t = d3.sum(d, function(p){ return p.enrolled; });
            if (!t) return null;
            return t/d3.sum(d, function(p){ return p.classes; });
          },
          "num_emp_growth": "mean",
          "num_emp_growth_5": "mean",
          "export_val_growth": "mean",
          "export_val_growth_5": "mean",
          "import_val_growth": "mean",
          "import_val_growth_5": "mean",
          "importance": "mean",
          "val_usd": function(leaves) {
            var directions = d3plus.util.uniques(leaves, function(l){ return l.direction; });
            if (directions.length === 2) {
              return d3.sum(leaves, function(l){
                return l.direction === "import_val" ? -l.val_usd : l.val_usd
              })
            }
            else {
              return d3.sum(leaves, function(l) {
                return l.val_usd;
              })
            }
          }
        }

    for (var k in averages) {
      if (k === "wage_avg") {
        averages["cp_bra_0_"+k] = function(d) {
          var t = d3.sum(d, function(p){ return p.cp_bra_0_wage; });
          if (!t) return null;
          return t/d3.sum(d, function(p){ return p.cp_bra_0_num_jobs; });
        }
        averages["cp_bra_1_"+k] = function(d) {
          var t = d3.sum(d, function(p){ return p.cp_bra_1_wage; });
          if (!t) return null;
          return t/d3.sum(d, function(p){ return p.cp_bra_1_num_jobs; });
        }
      }
      else {
        averages["cp_bra_0_"+k] = averages[k]
        averages["cp_bra_1_"+k] = averages[k]
      }
    }

    var descs = {
      "distance": dataviva.format.text("distance_desc"),
      "distance_wld": dataviva.format.text("distance_desc"),
      "importance": dataviva.format.text("importance_desc"),
      "eci": dataviva.format.text("eci_desc"),
      "opp_gain": dataviva.format.text("opp_gain_desc"),
      "opp_gain_wld": dataviva.format.text("opp_gain_desc"),
      "pci": dataviva.format.text("pci_desc"),
      "rca": dataviva.format.text("rca_desc"),
      "rca_wld": dataviva.format.text("rca_desc"),
      "required": dataviva.format.text("required_desc"),
      "bra_diversity": dataviva.format.text("bra_diversity_desc"),
      "bra_diversity_eff": dataviva.format.text("bra_diversity_eff_desc"),
      "cnae_diversity": dataviva.format.text("cnae_diversity_desc"),
      "cnae_diversity_eff": dataviva.format.text("cnae_diversity_eff_desc"),
      "cbo_diversity": dataviva.format.text("cbo_diversity_desc"),
      "cbo_diversity_eff": dataviva.format.text("cbo_diversity_eff_desc"),
      "hs_diversity": dataviva.format.text("hs_diversity_desc"),
      "hs_diversity_eff": dataviva.format.text("hs_diversity_eff_desc"),
      "wld_diversity": dataviva.format.text("wld_diversity_desc"),
      "wld_diversity_eff": dataviva.format.text("wld_diversity_eff_desc")
    }

    // Define global D3plus app parameters
    app.viz = d3plus.viz()
      .axes({"background": {"color": "white"}})
      .container("#app")
      .aggs(averages)
      .time({"solo": {"callback": app.title_update}})
      .legend({"size": [25,25], "filters": true})
      .format({
        "affixes": dataviva.format.affixes,
        "locale": dataviva.language === "pt" ? "pt_BR" : "en_US",
        "number": dataviva.format.number,
        "text": dataviva.format.text
      })
      .text(["name","display_id"])
      .background("transparent")
      .tooltip({"html": app.html})
      .font({
        "family": app.font,
        "weight": "normal"
      })
      .data({"padding": 0})
      .color({"missing": "#999"})
      .coords({"mute": ["2pe020000"]})
      .messages({"style": "large", "branding": true})
      .nodes({"overlap": 1.7})
      .shape({"interpolate": "monotone"})
      .title({
        "font": {"align": "left"},
        "padding": 5,
        "sub": {"font": {"align": "left"}},
        "total": {"font": {"align": "left"}}
      })
      .x({"label": {"font": {"weight": "normal"}}})
      .y({"label": {"font": {"weight": "normal"}}})

    app.redirect = function(url) {
      if (window.frameElement) {
        window.parent.location = url;
      }
      else {
        window.location = url;
      }
    }

    app.nesting = function(out) {

      if (!out) out = app.build.output_attr;

      if (out === "balance") {
        return ["trade_balance", "direction"];
      }
      else if (out === "university") {
        return ["school_type_id", "university_5"];
      }
      else if (out === "school") {
        return ["school_type_id", "school_8"];
      }
      else if (out === "time") {
        return ["time_period"];
      }
      else if (out === "type") {
        return ["student_type"];
      }
      else if (out === "age") {
        return ["course_sc_5","school_id"];
      }
      else if (out === "basic") {
        return ["course_sc_5"];
      }

      var nesting = [];
      depths[out].forEach(function(d){
        nesting.push(out+"_"+d);
      })
      return nesting;

    }

    // Start building a new app
    app.start = function(new_url, allyears) {

      // Hide popover
      dataviva.popover.hide();
      app.viz.data(false).attrs(false).coords([])
        .nodes(false).edges(false).focus(false).draw();
      app.allyears = allyears;

      if (new_url) {

        var url_split = new_url.split("?")
        app.url = url_split[0]
        if (url_split.length > 1) {
          var new_params = url_split[1].split("&");
          new_params.forEach(function(p){
            var p_split = p.split("=");
            app.vars[p_split[0]] = p_split[1];
          })
        }
        if (allyears) var t = "Downloading Additional Years"
        else var t = "Building Visualization"
        loading.text(dataviva.format.text(t)).show(app.create)

      }
      else {
        loading.text(dataviva.format.text("Building Visualization")).show(app.create)
      }

    }

    app.create = function() {

      d3.select("#controls").selectAll("*").remove();
      d3plus.tooltip.remove();
      var request_var_title = false
      var request_var = false
      var request_parameter = false
      if (app.vars.size) {
        request_var_title = "size"
        request_var = app.vars.size;}
      else if (app.vars.y) {
        request_var_title = "y"
        request_var = app.vars.y;}
      else if (app.vars.axes) {
        request_var_title = "axes"
        request_var = app.vars.axes;}

      if (request_var && request_var_title){

        var request_parameter = request_var_title + "=" + request_var;

      } else {

        var request_parameter = "/"
      }

      d3.json("/{{g.locale}}/embed/"+app.url+"?lang="+dataviva.language+"&" + request_parameter)
        .header("X-Requested-With", "XMLHttpRequest")
        .get(function(error, data){

          if (!error) {
            app.build = data.current_build;
            if (app.build.bra[0].id === "all") {
                if (["scatter", "occugrid"].indexOf(app.build.app.type) >= 0) {
                  error = dataviva.dictionary.no_brazil;
                }
                else if (["network"].indexOf(app.build.app.type) >= 0 && app.build.dataset === "rais") {
                  error = dataviva.dictionary.no_brazil;
                }
                else if (["adm", "age", "school"].indexOf(app.build.output) >= 0) {
                  error = dataviva.dictionary.no_brazil;
                }
            }
            if (app.build.app.type === "occugrid") {
              if (app.build.cnae[0].id.length !== depths.cnae[depths.cnae.length - 1]) {
                error = dataviva.dictionary.only_deepest;
              }
            }
            else if (app.build.app.type === "rings") {
              if (app.build[app.build.output_attr][0].id.length !== depths[app.build.output_attr][depths[app.build.output_attr].length - 1]) {
                error = dataviva.dictionary.only_deepest;
              }
            }
            else if (app.build.app.type === "bar" && app.build.output !== "bra" && app.build.bra[0].id !== "all") {
              error = dataviva.dictionary.only_brazil;
            }
          }
          else {
            console.log(error)
            error = dataviva.format.text("Build Not Available")
          }

          if (error) {
            app.viz.error(error);
            dataviva.resize()
            loading.hide()
          }
          else {

            app.star(data.starred);

            if (last_app && app.build.app.type !== last_app) {
              delete app.vars.year;
            }

            // Set public current build variable
            app.years = year_range[app.build.dataset];
            app.monthly = app.years[0].indexOf("-") > 0 &&
                          (app.build.dataset !== "secex" || ["stacked", "line"].indexOf(app.build.app.type) >= 0);
            app.timeRange = ["stacked", "line"].indexOf(app.build.app.type) >= 0 ||
                            ("box" === app.build.app.type && app.build.output !== "age");
            app.build.timeToggle = app.monthly && app.timeRange;
            app.timeFormat = app.monthly ? "%Y-%-m" : "%Y";
            app.timeFormat = d3.time.format(app.timeFormat);

            last_depth = app.build.bra[0].id == "all" ? "bra_3" : "bra_9";
            leon("#app_select").color(app.build.app.color)
            builder.url()

            // Remove unused global_vars
            var uis = ["year"];
            app.build.ui.forEach(function(ui){
              uis.push(ui.type);
            })
            if (app.build.timeToggle) {
              uis.push("time");
              app.vars.time = app.vars.time || (app.build.output === "balance" ? "month": "year");
            }
            for (v in app.vars) {
              if (uis.indexOf(v) < 0 && ["controls","builder"].indexOf(v) < 0) {
                delete app.vars[v];
              }
            }

            /***************************************/
            /* Data Calls and External Files Queue */
            /***************************************/

            var q = queue();

            if (!app.vars.year) {
              if (app.timeRange) {
                app.vars.year = app.years.join("_");
              }
              else {
                app.vars.year = app.years[1];
                if (!app.monthly && app.vars.year.indexOf("-")) {
                  app.vars.year = app.vars.year.slice(0,4);
                }
              }
            }
            else {

              var date_range = time2range(app.years)

              var years = app.vars.year.split("_").map(function(y){
                return d3plus.util.closest(date_range, string2date(y));
              });

              app.vars.year = app.timeURL(d3plus.util.uniques(years));

            }

            app.zero_add = app.vars.time !== "month" && app.build.dataset === "secex" && (!app.monthly || (!app.allyears && ["stacked", "line"].indexOf(app.build.app.type) >= 0));

            if (!app.allyears) {
              app.allyears = app.data[app.build.data_url] ||
                             app.vars.year.indexOf("_") > 0 || app.timeRange;
            }

            if (app.allyears && app.zero_add) {
              app.build.data_url = app.build.data_url.replace("all", "all-0")
            }
            else if (!app.allyears) {
              var y = app.vars.year;
              if (app.zero_add) {
                y = app.vars.year.split("_").map(function(yy){
                  return yy+"-0";
                }).join("_");
              }
              app.build.data_url = app.build.data_url.replace("all", y)
            }



            if (!app.data[app.build.data_url]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.data_url] = {}
                    app.data[app.build.data_url].raw = dataviva.cleanData(d, app.build.dataset, app.build.output)
                    if (d.eci) app.ecis[app.build.data_url] = d.eci
                    callback(error,d)
                  })
              },"/"+app.build.data_url)
            }

            if (["time", "balance", "type"].indexOf(app.build.output_attr) < 0 && !app.attrs[app.build.output_attr]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    localforage.setItem(u, d);
                    app.attrs[app.build.output_attr] = cleanAttrs(d, app.build.output_attr);
                    callback(error,d);
                  })
              },"/attrs/"+app.build.output_attr+"/"+"?lang="+dataviva.language)
            }

            if (["adm", "age", "school"].indexOf(app.build.output) >= 0) {
              app.build.bra.forEach(function(b){

                if (!app.attrs["school_"+b.id]) {

                  q.defer(function(u, callback){
                    d3.json(u)
                      .header("X-Requested-With", "XMLHttpRequest")
                      .get(function(error,d){
                        app.attrs["school_"+b.id] = d.data.reduce(function(obj, s){
                          obj[s.id] = s;
                          if (app.attrs.school) app.attrs.school.school_8[s.id] = s;
                          return obj;
                        }, {});
                        callback(error,d);
                      })
                  },"/attrs/school/in/"+b.id+"/?lang="+dataviva.language)

                }
                else if (app.attrs.school) {
                  for (var s in app.attrs["school_"+b.id]) {
                    app.attrs.school.school_8[s] = app.attrs["school_"+b.id][s];
                  }
                }

              })
            }

            if (["network","rings"].indexOf(app.build.app.type) >= 0
                && !app.networks[app.build.output_attr]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){

                    var out = app.build.output_attr;
                    d.nodes.forEach(function(node){
                      if (out === "cnae") {
                        var id = node.id;
                      }
                      else {
                        var id = node[out+"_id"];
                      }
                      depths[out].forEach(function(depth){
                        node[out+"_"+depth] = id.substr(0,depth);
                      })
                    })

                    if (app.build.output_attr === "hs") {
                      d.edges.forEach(function(edge){
                        edge.source = d.nodes[edge.source]
                        edge.target = d.nodes[edge.target]
                      })
                    }

                    app.networks[app.build.output_attr] = d
                    callback(error,d)
                  })
              },"/{{g.locale}}/embed/networks/"+app.build.output_attr+"/")
            }

                d3.selectAll("#settings #file").style("display","inline-block");
            if (app.build.app.type == "geo_map") {
                  d3.selectAll("#settings #file").style("display","none");
              if (app.build.bra[0].id == "all") {
                var json_id = "all"
              }
              else {
                var json_id = app.build.bra[0].id.substr(0,3)
              }

              if (!app.coords[json_id]) {
                q.defer(function(u,callback){
                  d3.json(u)
                    .header("X-Requested-With", "XMLHttpRequest")
                    .get(function(error,d){
                      app.coords[json_id] = d
                      callback(error,d)
                    })
                },"/{{g.locale}}/embed/coords/"+json_id+"/")
              }

            }

            if (app.build.app.type == "occugrid") {

              var url = app.build.data_url.split("/")
              url[2] = "all"
              app.build.imp_url = url.join("/")

              if (!app.data[app.build.imp_url]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.imp_url] = {}
                    app.data[app.build.imp_url].raw = dataviva.cleanData(d, app.build.dataset, app.build.output)
                    callback(error,d)
                  })
                },"/"+app.build.imp_url)
              }

              var url = app.build.data_url.split("/")
              url[3] = "all"
              app.build.else_url = url.join("/")

              if (!app.data[app.build.else_url]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.else_url] = {}
                    app.data[app.build.else_url].raw = dataviva.cleanData(d, app.build.dataset, app.build.output)
                    callback(error,d)
                  })
                },"/"+app.build.else_url)
              }

              var url = app.build.data_url.split("/");
              url[3] = url[3] + ".show." + url[3].length;
              url[4] = "all";
              url[5] = "?required_bras=true";
              app.build.bra_prox = url.join("/");

              if (!app.data[app.build.bra_prox]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.bra_prox] = d.data
                    callback(error,d)
                  })
                },"/"+app.build.bra_prox)
              }

            }

            q.awaitAll(app.finish)

          }
        });

    }

    app.error = function(error) {
      console.log("[dataviva] ERROR: "+error)
      dataviva.resize()
      app.viz.error(error).draw()
      loading.hide()
    }

    var required_bras = function() {

      if (app.build.bra_prox) {

        var locs = app.data[app.build.bra_prox][app.vars.year.length > 4 ? "2013" : app.vars.year] || [];

        var btn = d3.select("#controls").selectAll("#required_bras")
          .data(locs.length ? [0] : []);

        var text = dataviva.format.text(locs.length === 10 ? "required_bras_desc_top" : "required_bras_desc") + " "
        locs.forEach(function(b, i){
          if (i && locs.length > 2) text += ", ";
          if (i && i === locs.length - 1) {
            text += dataviva.format.text("and") + " ";
          }
          text += b.name;
        })

        btn.exit().remove();

        btn.enter().append("div")
          .attr("class","ui_group alt_tooltip")
          .attr("id", "required_bras")
          .text(dataviva.format.text("required_bras"))
          .append("i").attr("class", "fa fa-location-arrow")

        btn
          .attr("alt", text)
          .on(d3plus.client.pointer.over,function(){
            dataviva.ui.tooltip("alt_tooltip",this)
          })
          .on(d3plus.client.pointer.out,function(){
            dataviva.ui.tooltip("alt_tooltip",false)
          })

      }

    };

    app.finish = function() {

      d3.select("#controls").selectAll("*").remove();

      if (app.build.timeToggle) {
        app.build.ui.push({
          "type": "time",
          "values": ["year", "month"]
        })
      }

      app.build.ui.forEach(function(ui){

        // Custom Titles
        if (ui.type == "size") {
          if (app.build.app.type == "geo_map") var title = "color"
          else var title = "sizing"
        }
        else if (ui.type == "spotlight" && app.build.app.type == "scatter") {
          var title = "spotlight_scatter"
        }
        else var title = ui.type
        // Set Global Vars
        if (ui.type == "size") {
          if (app.build.app.type == "occugrid") var default_value = "required"
          else if (ui.values.indexOf("export_val") >= 0) var default_value = "export_val"
          else if (ui.values.indexOf("num_jobs") >= 0) var default_value = "num_jobs"
          else var default_value = ui.values[0]
        }
        else if (ui.type == "depth") {

          if (app.build.dataset !== "ei" && app.build.output_attr === "bra") {
            var bra_id = app.build.bra[0].id;
            if (bra_id !== "all") {
              ui.values = ui.values.splice(ui.values.indexOf("bra_"+bra_id.length)+1)
            }
          }

          if ((app.build.app.type === "tree_map" && app.build.output !== "school") ||
              app.build.app.type === "compare") {
            var default_value = ui.values[ui.values.length-1]
          }
          else {
            var default_value = ui.values[0]
          }

        }
        else if (ui.type == "order" && app.build.app.type == "stacked") {
          var default_value = "color"
        }
        else if (ui.type == "spotlight" && app.build.app.type == "scatter") {
          var default_value = ui.values[1]
        }
          else if(ui.type == "spotlight"){
                var default_value = "true"
          }
        else {
          var default_value = ui.values[0]
        }

        if((ui.type === "depth" && last_app && last_app != app.build.app.type) || (!app.vars[ui.type] || ui.values.indexOf(app.vars[ui.type]) < 0)) {
          app.vars[ui.type] = default_value;
        }

        if (ui.values.length > 1 && app.vars.builder !== "false" && (app.build.app.type != "network" || app.build.bra[0].id != "all" || (ui.type != "spotlight" && ui.type != "rca_scope") || (ui.type == "spotlight" && app.build.output_attr == "hs") || (ui.type != "color" && app.build.app.type != "stacked"))) {

          var ui_data = []
          ui.values.forEach(function(v){
            if(!(v == "bra_rca" &&  app.build.bra[0].id == "all" &&  app.build.app.type == "network")) {
              ui_data.push({
                "text": dataviva.format.text(v),
                "value": v
              })
            }
          })

          var ui_limit = app.build.ui.length > 3 ? 1 : 3;
          var form_type = ui_data.length > ui_limit ? "drop" : "toggle";
          if (["color"].indexOf(title) >= 0) {
            form_type = "drop";
          }
          else if (["time", "school_type"].indexOf(title) >= 0) {
            form_type = "toggle";
          }

                var ui_div = d3.select("#controls").append("div")
                .attr("class","ui_group alt_tooltip")
                .attr("alt",dataviva.format.text(title+"_desc_"+app.build.app.type))
                .on(d3plus.client.pointer.over,function(){
                  if (form_type === "drop") dataviva.ui.tooltip("alt_tooltip",this,"center right")
                  else dataviva.ui.tooltip("alt_tooltip",this)
                })
                .on(d3plus.client.pointer.out,function(){
                  dataviva.ui.tooltip("alt_tooltip",false)
                })

          if (title === "color") title = "color_toggle";

          d3plus.form()
            .container({
              "id": "ui_" + ui.type,
              "value": ui_div
            })
            .type(form_type)
            .data({
              "sort": false,
              "value": ui_data
            })
            .text("text")
            .id("value")
            .focus(app.vars[ui.type], app.update)
            .title(dataviva.format.text(title))
            .ui({
              // "color": app.build.app.color
              "margin": 0
            })
            .draw()

        }

      })

      if (!app.allyears) {

        var year = d3.select("#controls").append("div")
            .attr("class","ui_group alt_tooltip")
            .attr("alt", dataviva.format.text("all_years"))
            .attr("id","year_slider")
            .on(d3plus.client.pointer.over,function(){
                  dataviva.ui.tooltip("alt_tooltip",this)
                })
                .on(d3plus.client.pointer.out,function(){
                  dataviva.ui.tooltip("alt_tooltip",false)
                })

        d3plus.form()
          .container(year)
          .id("id")
          .text("text")
          .type("button")
          .icon({"button": "fa-calendar"})
          .data([{"id": "all", "text": dataviva.format.text("Show All Years")}])
          .focus("none",function(){
            app.start(app.url, true);
          })
          .ui({"margin": 0})
          .draw()

      }

      required_bras();

      // Format Data if it hasn't already been formatted
      // if (!app.data[app.build.data_url][format[app.build.app.type]]) {
      app.format_data()
      // }

      if (app.build.output_attr === "balance") {
        app.viz.text({"trade_balance": "trade_balance", "direction": "direction"});
      }
      else {
        app.viz.text("name");
      }

      if (app.build.output === "time") {
        app.viz.legend({"order": "id"});
      }
      else {
        app.viz.legend({"order": "color"});
      }

      var nesting = app.nesting(app.build.output === "age" ? "age" : app.build.output_attr);
      if (app.build.app.type === "box" && app.build.output !== "age") {
        nesting = [nesting[nesting.length-1]]
      }

      app.solos = []
      app.filters = []
      builder.url()

      var color_var = app.vars.color ? app.vars.color : "color"

      /************************/
      /* Gloabl App Variables */
      /************************/
      var style = {}
      nesting.forEach(function(n){
        style[n] = (app.build.output_attr == "bra" && n !== "bra_1") ||
                   (app.build.output_attr == "wld" && n == "wld_5") ?
                   "default" : "knockout"
      });

      app.tooltip["short"][""] = [""]
      app.tooltip["long"][""] = [""]
      if (app.build.output_attr == "bra") {
        app.tooltip["short"][""] = ["id_ibge"]
        app.tooltip["long"][""] = ["id_ibge"]
      }
      else {
        app.tooltip["short"][""] = [app.build.output_attr+"_display"]
        app.tooltip["long"][""] = [app.build.output_attr+"_display"]
        if (app.build.app.type == "occugrid") {
          app.tooltip["short"][""].push("required");
          app.tooltip["short"][""].push("num_jobs");
          app.tooltip["short"][""].push("elsewhere");
        }
      }

      if (app.monthly && (!app.vars.time || app.vars.time === "month")) {
        app.tooltip.short[""].push("month");
      }
      else if (app.build.app.type === "bar") {
        app.tooltip.short[""].push("share");
        app.tooltip.long[""].push("share");
      }

      if (app.build.bra[0].id == "all" && app.build.app.type == "network") {
        app.vars.spotlight = false
      }
      else if (app.vars.spotlight === "true") {
        app.vars.spotlight = true
      }
      else if (app.vars.spotlight === "false") {
        app.vars.spotlight = false
      }

      if ("grouping" in app.vars) {
        if (app.vars.grouping === "true") {
          app.vars.grouping = true
        }
        else if (app.vars.grouping === "false") {
          app.vars.grouping = false
        }
      }

      if (app.timeRange &&
          app.vars.year.indexOf("_") < 0) {
        app.vars.year = app.timeURL(app.years);
      }

      var timeSolo = app.vars.year && app.vars.year !== app.years.join("_") ?
                     time2range(app.vars.year.split("_")) : [];

      var depth = nesting.indexOf(app.vars.depth);
      if (depth < 0) {
        if (app.build.dataset !== "ei" && app.build.output_attr === "bra") {
          var bra_id = app.build.bra[0].id;
          if (bra_id !== "all") {
             depth = nesting.indexOf("bra_"+bra_id.length)+1;
          }
        }
        else {
          depth = 0;
        }
      }

      app.viz
        .type(app.build.app.d3plus)
        .title({
          "sub": app.sub_title(),
          "total": app.total(),
          "value": app.build.title
        })
        .color(color_var)
        .id({"solo": false})
        .attrs(app.attrs[app.build.output_attr])
        .active({"spotlight": app.vars.spotlight})
        .id(nesting)
        .depth(depth, function(){ app.title_update() })
        .id({"grouping": app.vars.grouping || false})
        .order({
          "sort": app.vars.sort,
          "value": app.vars.order
        })
        // .layout(app.vars.layout)
        .size(app.vars.size)
        .size({"threshold": ["stacked", "line"].indexOf(app.build.app.type) >= 0 ?
                            function(vars){
                              return vars.depth.value > 0 ? 10/vars.height.viz : 0;
                            } : false })
        .focus(false)
        .error(false)
        // .id({
        //   "solo": app.solos,
        //   "mute": app.filters
        // })
        .icon({
          "style": style,
          "value": "icon"
        })
        .legend({"icons": app.build.output_attr !== "bra"})
        .legend(app.build.output !== "age")
        .y(false)
        .y({"stacked": app.build.app.type === "stacked"})
        .y({"ticks": {"values": false}})
        .x({"scale": "linear"})
        .tooltip(app.tooltip)
        .tooltip({"children": app.build.output !== "balance"})
        .zoom(["balance", "adm"].indexOf(app.build.output) < 0)
        .time(app.vars.time || (app.monthly ? "month" : "year"))
        .time({"solo": timeSolo})
        .y({"label": {"font": {"size": app.build.app.type === "compare" ? 16 : 22 }}})
        .x({"label": {"font": {"size": app.build.app.type === "compare" ? 16 : 22 }}})
        .x({"label": ["compare", "bar", "scatter"].indexOf(app.build.app.type) >= 0 ? true : false})
        .labels({"font": {"size": 11}})

      if (same_origin &&
          (window.parent.location.href.indexOf("dataviva.info") >= 0 ||
          window.parent.location.href.indexOf("localhost") >= 0 ||
          window.parent.location.href.indexOf("datawheel.us") >= 0)) {
        app.viz.footer(dataviva.dictionary[app.build.dataset+"_footer"]);
      }
      else {
        app.viz.footer({
          "value": dataviva.dictionary.embed_footer,
          "link": location.href.replace("embed", "builder")
        });
      }

      app.viz.labels({"align": "center", "valign": "middle"})

      /*******************************/
      /* Tree Map Specific Variables */
      /*******************************/
      if (app.build.app.type === "tree_map") {

        app.viz
          .labels({"align": "left", "valign": "top"})
          .active(false)
          .temp(false)
          .total(false)
          .zoom(false)
          .id({"grouping": true})
          .shape("square")
          .type({"mode": "squarify"})
          .order(false)

      }

      /******************************/
      /* Network Specific Variables */
      /******************************/
      else if (app.build.app.type == "network") {
        if ((app.build.bra[0].id === "all" && app.build.output_attr !== "hs") || app.build.output_attr === "cbo") {
          app.viz.active(function(d){return true;})
        }
        else if (app.build.output_attr == "hs") {
          if (app.vars.rca_scope == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
        }
        else if (app.build.output_attr == "cnae") {
          app.viz.active(function(d){
            return d.rca >= 1;
          })
        }

        app.viz
          .edges(app.networks[app.build.output_attr].edges)
          .nodes(app.networks[app.build.output_attr].nodes)
          .depth(app.viz.id(Object).nesting.length - 1)
          .size({"scale": {"min": 5}})
          .shape("circle")
          .order(false)
      }

      /****************************/
      /* Rings Specific Variables */
      /****************************/
      else if (app.build.app.type == "rings") {
        if (app.build.output_attr == "hs") {
          if (app.vars.rca_scope == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
        }
        else if (app.build.output_attr == "cnae") {
          app.viz.active(function(d){
            return d.rca >= 1;
          })
        }
        else {
          app.viz.active(function(d){return true;})
        }
        app.viz
          .edges(app.networks[app.build.output_attr].edges)
          .nodes(app.networks[app.build.output_attr].nodes)
          .focus(app.build[app.build.output_attr][0].id)
          .depth(app.viz.id(Object).nesting.length - 1)
          .size(false)
          // .nodes({"overlap": 0.5})
          .size({"scale": {"min": 3}})
          .shape("circle")
          .order(false)
      }

      /******************************/
      /* Geo Map Specific Variables */
      /******************************/
      else if (app.build.app.type == "geo_map") {
        if (app.build.bra[0].id == "all") {
          var depth = 1;
        }
        else {
          var depth = 4;
        }
        if (app.build.bra[0].id == "all") {
          var coords = app.coords.all
        }
        // else if (app.build.bra[0].id.indexOf("plr") >= 0) {
        //   var coords = {"type": "Topology", "objects": {"geojson": {"geometries": [], "type": "GeometryCollection"}}}
        //   coords.transform = app.coords[app.build.bra[0].id.substr(0,3)].transform
        //   coords.arcs = app.coords[app.build.bra[0].id.substr(0,3)].arcs
        //   coords.objects.geojson.geometries = app.coords[app.build.bra[0].id.substr(0,3)].objects.geojson.geometries.filter(function(g){
        //     return app.build.bra[0].pr_ids.indexOf(g.id) >= 0
        //   })
        // }
        else if (app.build.bra[0].id.length == 5) {
          var coords = {"type": "Topology", "objects": {"geojson": {"geometries": [], "type": "GeometryCollection"}}}
          coords.transform = app.coords[app.build.bra[0].id.substr(0,3)].transform
          coords.arcs = app.coords[app.build.bra[0].id.substr(0,3)].arcs
          coords.objects.geojson.geometries = app.coords[app.build.bra[0].id.substr(0,3)].objects.geojson.geometries.filter(function(g){
            return g.id.substr(0,5) == app.build.bra[0].id
          })
        }
        else if (app.build.bra[0].distance > 0) {
          var coords = {"type": "Topology", "objects": {"geojson": {"geometries": [], "type": "GeometryCollection"}}}
          coords.transform = app.coords[app.build.bra[0].id.substr(0,3)].transform
          coords.arcs = app.coords[app.build.bra[0].id.substr(0,3)].arcs
          coords.objects.geojson.geometries = app.coords[app.build.bra[0].id.substr(0,3)].objects.geojson.geometries.filter(function(g){
            return app.build.bra[0].neighbor_ids.indexOf(g.id) >= 0
          })
        }
        else {
          var coords = app.coords[app.build.bra[0].id.substr(0,3)]
        }

        app.viz
          .coords(coords)
          .focus(false)
          .active(false)
          .temp(false)
          .total(false)
          .depth(depth)
          .shape("coordinates")
          .order(false)

      }

      /******************************/
      /* Bubbles Specific Variables */
      /******************************/
      else if (app.build.app.type == "occugrid") {

        if (app.vars.order === "name") {
          app.viz.order({"sort": "asc"})
        }
        else {
          app.viz.order({"sort": "desc"})
        }

        app.viz
          .active("num_jobs")
          .temp("elsewhere")
          .total("required")
          .shape("donut")
          .size({"scale": {"min": 10}})
          .labels({"font": {"size": 13}})
          .depth(app.viz.id(Object).nesting.length - 1)
      }

      /******************************/
      /* Stacked Specific Variables */
      /******************************/
      else if (app.build.app.type == "stacked") {

        // var layout = app.build.ui.filter(function(ui){ return ui.type === "layout"; });
        // if (layout) layout = layout[0].values[0];
        // else layout = "linear"
        var layout = app.vars.layout;
        if (layout === "value") layout = "linear";
        app.viz
          .x({
            "scale": "linear",
            "value": app.vars.time || (app.monthly ? "month" : "year")
          })
          .y({
            "scale": layout,
            "value": app.vars.y
          })
          .active(false)
          .temp(false)
          .total(false)
          .id({"grouping": true})
          .shape("area")
          .order(app.vars.order)
          .depth(app.build.output_attr === "bra" ? 1 : app.build.output === "basic" ? 1 : 0)
      }

      /******************************/
      /* Scatter Specific Variables */
      /******************************/
      else if (app.build.app.type == "scatter") {
        if (app.build.output_attr == "hs") {
          if (app.vars.rca_scope == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
        }
        else {
          app.viz.active(function(d){
            return d.rca >= 1;
          })
        }
        if (app.build.output_attr == "hs" && app.vars.rca_scope == "wld_rca") {
          var yv = app.vars.y + "_wld",
              xv = app.vars.x + "_wld"
        }
        else {
          var yv = app.vars.y,
              xv = app.vars.x
        }
        if (app.vars.y.indexOf("pci") >= 0) yv = app.vars.y

        app.viz
          .x({
            "scale": "linear",
            "value": xv
          })
          .y({
            "scale": "linear",
            "value": yv
          })
          .axes({"mirror": false})
          .active({"spotlight": app.vars.spotlight})
          .temp(false)
          .total(false)
          .size({"scale": {"min": 3}})
          .id({"grouping": true})
          .shape("circle")
          .order(false)
      }

      /******************************/
      /* Compare Specific Variables */
      /******************************/
      else if (app.build.app.type == "compare") {

        app.viz
          .x({
            "scale": app.vars.scale,
            "value": "cp_bra_1_"+app.vars.axes
          })
          .y({
            "scale": app.vars.scale,
            "value": "cp_bra_0_"+app.vars.axes
          })
          .axes({"mirror": true})
          .active({"spotlight": false})
          .active(false)
          .temp(false)
          .total(false)
          .size({"scale": {"min": 3}})
          .id({"grouping": true})
          .shape("circle")
          .order(false)

      }

      /***************************/
      /* Line Specific Variables */
      /***************************/
      else if (app.build.app.type === "line") {

        app.viz
        .x(app.vars.time || (app.monthly ? "month" : "year"))
        .y({
          "scale": app.vars.scale,
          "value": app.vars.y
        })
        .axes({"mirror": false})
        .active({"spotlight": false})
        .active(false)
        .temp(false)
        .total(false)
        .id({"grouping": true})
        .shape("line")
        .order(false)
        .depth(app.build.output_attr === "bra" ? 1 : ["basic", "balance"].indexOf(app.build.output) >= 0 ? 1 : 0)

      }

      /**************************/
      /* Box Specific Variables */
      /**************************/
      else if (app.build.app.type === "box") {

        app.viz
        .y({"scale": "linear"})
        .axes({"mirror": false})
        .active({"spotlight": false})
        .active(false)
        .temp(false)
        .total(false)
        .id({"grouping": true})
        .shape("circle")
        .type({"mode": "extent"})
        .y(app.vars.y)

        if (app.build.output === "age") {
          app.viz
            .order("course_sc_5")
            .order({"sort": "asc"})
            .x("course_sc_5")

          app.school_filter = app.vars.school_type === "all" ? false : app.vars.school_type.split("_")[1].toUpperCase();
          app.viz.id({"solo": function(id){
            if (!app.school_filter) return true;
            return id.length === 8 ? app.attrs["school_"+app.build.bra[0].id][id].school_type_id === app.school_filter : false;
          }})
        }
        else {
          app.viz
            .order(false)
            .x(app.vars.time || (app.monthly ? "month" : "year"))
        }

      }

      /**************************/
      /* Bar Specific Variables */
      /**************************/
      else if (app.build.app.type === "bar") {

        app.viz
        .y({"scale": "linear"})
        .axes({"mirror": false})
        .active({"spotlight": false})
        .active(false)
        .temp(false)
        .total(false)
        .depth(nesting.indexOf(app.build.output+"_"+app.build[app.build.output][0].id.length))
        .id({"grouping": true})
        .shape("rect")
        .y("num_jobs")
        .x("wage_month")
        .order("wage_order")
        .order({"sort": "asc"})

      }

      last_app = app.build.app.type;

      var data_array = app.data[app.build.data_url][format[app.build.app.type]];

      app.viz.data(data_array);

      app.title_update();
      dataviva.resize();
      loading.hide();
      app.first_load = true;

    }

    app.sub_title = function() {
      var elems = app.build.bra,
          same = elems.length == 1 || (elems.length == 2 && elems[0].id.length == elems[0].id.length),
          mix = elems.length == 2 && (elems[0].id == "all" || elems[1].id == "all") && (elems[0].id.length == 2 || elems[1].id.length == 2)
          depth = elems[0].id.length,
          secex = app.build.dataset.indexOf("secex") === 0,
          munics = app.build.output_attr == "bra",
          text = "";
      if (secex && same && !mix) {
        if ((munics && depth >= 3) || (app.build.output_attr === "balance" && depth > 3)) {
          text = dataviva.format.text("secex_9")
        }
        else {
          text = dataviva.format.text("secex_3")
        }
        descs["export_val"] = text
        descs["import_val"] = text
        app.viz.descs(descs)
      }
      else if (app.build.app.type === "bar" && app.sub_data && app.sub_data[app.vars.year]) {
        var d = app.sub_data[app.vars.year];

        if (d.wage_avg) {
          text += dataviva.format.text("wage_avg") + ": " + dataviva.format.number(d.wage_avg, {"key": "wage_avg"});
        }
        if (d.gini) {
          if (text.length) text += ", ";
          text += "GINI: " + dataviva.format.number(d.gini, {"key": "gini"});
        }

      }

      if (["stacked", "line"].indexOf(app.build.app.type) >= 0 && !app.monthly && app.build.output !== "time") {
        var joiner = text.length ? ", " : ""
        text += joiner + dataviva.format.text("Click to Zoom");
        if (joiner.length) text += ".";
      }
      return text.length ? text : false;
    }

    app.update = function(value, type) {

      if (typeof type !== "string") {
        type = type.container(Object).id.slice(3);
      }

      if (type == "school_type") {
        app.vars[type] = value;
        builder.url();
        app.school_filter = value === "all" ? false : value.split("_")[1].toUpperCase();
        app.viz.id({"solo": function(id) {
              if (!app.school_filter) return true;
              return id.length === 8 ? app.attrs["school_"+app.build.bra[0].id][id].school_type_id === app.school_filter : false;
          }}).draw()
      }
      else if (type == "solo" || type == "filter") {

        app[type+"s"] = value

        var ids = []
        if (app.solos.length >= 1 && app.solos.length <= app.categories.length/2) {
          var prefix = dataviva.format.text("showing")+" "
          ids = app.solos
        }
        else if (app.solos.length > app.categories.length/2) {
          var prefix = dataviva.format.text("excluding")+" "
          cats.forEach(function(c){
            if (app.solos.indexOf(c) < 0) ids.push(c)
          })
        }
        else if (app.filters.length >= 1 && app.filters.length <= app.categories.length/2) {
          var prefix = dataviva.format.text("excluding")+" "
          ids = app.filters
        }
        else if (app.filters.length > app.categories.length/2) {
          var prefix = dataviva.format.text("showing")+" "
          cats.forEach(function(c){
            if (app.filters.indexOf(c) < 0) ids.push(c)
          })
        }

        var names = []
        ids.forEach(function(id){
          names.push(app.attrs[app.build.output_attr][id].name)
        })

        if (names.length > 0) {
          var text = prefix
          names.forEach(function(n,i){
            if (i != 0 && names.length != 2) text += ", "
            if (i == names.length-1 && i != 0) text += " "+dataviva.format.text("and")+" "
            text += n
          })
          var sub = text
        }
        else {
          var sub = false
        }

        var method = type === "filter" ? "mute" : "solo";
        var filterObj = {}
        if (app[type+"s"].length) {
          filterObj[method] = app[type+"s"]
        }
        else {
          filterObj[method] = false
        }

        app.viz.id(filterObj).title({"sub": sub}).draw()

      }
      else if (type === "time") {

          var old_value = app.vars[type];
          app.vars[type] = value;

          if (value === "month") {
            app.tooltip.short[""] = ["month"];
          }
          else {
            app.tooltip.short[""] = [];
          }

          if (app.zero_add && value === "month") {
            app.start(app.url, true);
          }
          else {
            builder.url();
            app.viz.time(value).x(value);
            app.title_update();
            app.viz.draw();
          }

      }
      else {

        var old_value = app.vars[type]
        app.vars[type] = value
        builder.url()

        if (!app.solos.length && !app.filters.length) {
          app.viz.title({"sub": app.sub_title()})
        }

        if (type == "axes") {
          app.viz.x("cp_bra_1_"+value).y("cp_bra_0_"+value)
        }
        else if (type == "scale") {
          app.viz.x({"scale": value}).y({"scale": value})
        }
        else if (type == "rca_scope") {
          if (value == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
          if (app.build.app.type === "scatter") {
            if (app.build.output_attr === "hs" && value === "wld_rca") {
              var yv = app.vars.y + "_wld",
                  xv = app.vars.x + "_wld"
            }
            else {
              var yv = app.vars.y,
                  xv = app.vars.x
            }
            if (app.vars.y.indexOf("pci") >= 0) yv = app.vars.y;
            app.viz.x(xv).y(yv)
          }
        }
        else if (type == "x") {
          if (app.vars.rca_scope == "wld_rca") {
            var xv = app.vars.x + "_wld"
          }
          else {
            var xv = app.vars.x
          }
          app.viz.x(xv).title({"total": app.total()})
        }
        else if (type == "y") {
          if (app.vars.rca_scope == "wld_rca" && app.vars.y.indexOf("pci") < 0) {
            var yv = app.vars.y + "_wld"
          }
          else {
            var yv = app.vars.y
          }
          app.viz.y(yv).title({"total": app.total()})
        }
        else if (type == "size") {
          if (app.viz.order() === app.viz.size()) {
            app.viz.order(value)
          }
          app.viz[type](value).title({"total": app.total()})
        }
        else if (type === "depth") {
          app.viz[type](app.viz.id(Object).nesting.indexOf(value))
        }
        else if (type === "layout") {
          var yscale = value === "value" ? "linear" : "share";
          app.viz.y({"scale": yscale})
        }
        else if (type === "sort") {
          app.viz.order({"sort": value})
        }
        else if (type === "order" && value === "value") {
          app.viz.order(app.viz.size())
        }
        else if (type === "spotlight") {
          if (value === "true") {
            value = true;
          }
          else {
            value = false;
          }
          app.viz.active({"spotlight": value})
        }
        else if (type === "grouping") {
          if (value === "true") {
            value = true;
          }
          else {
            value = false;
          }
          app.viz.id({"grouping": value})
        }
        else {
          app.viz[type](value);
        }

        if (type === "order" && app.build.app.type === "occugrid") {
          if (value === "name") {
            app.viz.order({"sort": "asc"})
          }
          else {
            app.viz.order({"sort": "desc"})
          }
        }

        app.title_update();
        app.viz.draw();

      }
    }

    app.format_data = function() {

      var data_obj = [],
          data = app.data[app.build.data_url],
          out = app.build.output_attr,
          attr = app.attrs[out];

      if (out === "school" || app.build.output === "age") {
        data.raw.forEach(function(d){
          d.school_8 = d.school_id;
          var sb = "school_"+d.bra_id;
          if (out === "school" && attr.school_8[d.school_8]) {
            d.school_type_id = attr.school_8[d.school_8].school_type_id;
          }
          else if (app.attrs[sb] && app.attrs[sb][d.school_8]) {
            d.school_type_id = app.attrs[sb][d.school_8].school_type_id;
          }

        })
      }

      if ("hist" === format[app.build.app.type]) {
        var new_data = data.raw;
        if (app.build.bra[0].id === "all") {
          new_data = d3.values(new_data.reduce(function(obj, d){
            if (!obj[d.year]) obj[d.year] = [];
            obj[d.year].push(d);
            return obj;
          }, {})).reduce(function(arr, d){
            var histMerge = d.reduce(function(obj, d){
              if (!d.hist) d.hist = '{}';
              var h = JSON.parse(d.hist.replace(/'/g,"\""));
              for (var r in h) {
                if (!obj[r]) obj[r] = h[r];
                else obj[r] += h[r];
              }
              return obj;
            }, {});
            var obj = {
              "hist": JSON.stringify(histMerge),
              "year": d[0].year,
              "wage_avg": d3.sum(d, function(p){ return p.wage; })/d3.sum(d, function(p){ return p.num_jobs; }),
              "gini": d3.mean(d, function(p){ return p.gini; })
            }
            obj[out+"_id"] = app.build[app.build.output][0].id;
            arr.push(obj);
            return arr;
          }, []);
        }
        app.sub_data = {};
        new_data.forEach(function(point){

          app.sub_data[point.year] = point;

          var id = point[out+"_id"];
          attr = app.build[out][0];
          if (!point.hist) point.hist = '{}';
          var hist = JSON.parse(point.hist.replace(/'/g,"\"")),
              ranges = d3.keys(hist).sort(function(a, b){ return a.split(",")[0] - b.split(",")[0]; }),
              total = d3.sum(d3.values(hist));

          ranges.forEach(function(range, i){
            var label = range.split(",").map(function(r){ return d3.format(",")(r); });
            if (dataviva.language === "pt") {
              label = label.map(function(r){ return r.replace(/,/g, "."); });
            }
            if (i === 0 && label[0] !== 0) {
              label = "0-" + label[1];
            }
            else if (i === ranges.length - 1) {
              label = label[0] + "+";
            }
            else {
              label = label.join("-");
            }
            var obj = {
              "num_jobs": hist[range],
              "wage_month": label,
              "wage_order": i,
              "year": point.year,
              "share": (hist[range]/total) * 100
            };
            if (id === "all") {
              obj.name = dataviva.dictionary.brazil;
              obj.color = "#00923f";
              obj.icon = dataviva.icon("all", "bra");
            }
            obj[out+"_"+id.length] = id;
            data_obj.push(obj);
          })

        })
      }
      else if ("occugrid" === format[app.build.app.type]) {

        var jobs = app.data[app.build.imp_url].raw.sort(function(a,b){
          return b.importance - a.importance
        })

        var year_jobs = {}
        jobs.forEach(function(j){
          if (j.importance >= 0.2) {
            if (!year_jobs[j.year]) year_jobs[j.year] = [j]
            else year_jobs[j.year].push(j)
          }
        })

        for (year in year_jobs) {
          year_jobs[year].forEach(function(job){
            var d = data.raw.filter(function(x){
              return x.cbo_id == job.cbo_id && x.year == year
            })[0]
            if (d && d.required) {
              d.importance = job.importance
              d.category = attr.cbo_1[d[out+"_id"].slice(0,depths[out][0])].name
              d.none = 1

              d.required = Math.ceil(d.required)

              d.wage_avg_bra = job.wage_avg

              var else_data = app.data[app.build.else_url].raw.filter(function(e){
                return e.cbo_id == d.cbo_id && e.year == d.year
              })[0]

              d.active = d.num_jobs/d.required >= 1 ? true : false

              if (!else_data) d.elsewhere = 0
              else d.elsewhere = else_data.num_jobs-d.num_jobs

              d[out+"_display"] = dataviva.displayID(d[out+"_id"],out)
              // d.icon = dataviva.icon(d[out+"_id"],out)

              // get_keys(d)

              data_obj.push(d)

            }
          })
        }

      }
      else if ("compare" == format[app.build.app.type]) {

        d3.nest()
          .key(function(d){return d.year})
          .key(function(d){
            return app.build.output === "adm" ? d.school_type_id : d[out+"_id"];
          })
          .rollup(function(leaves){

            if (leaves.length > 1) {

              var d = {}
              d.year = leaves[0].year

              if (app.build.output === "adm") {
                d.school_type_id = leaves[0].school_type_id;
              }
              else {
                d[out+"_id"] = leaves[0][out+"_id"]
                d[out+"_display"] = dataviva.displayID(d[out+"_id"],out)
                depths[out].forEach(function(dd){
                  d[out+"_"+dd] = leaves[0][out+"_"+dd]
                })
              }

              for (var key in leaves[0]) {
                if (typeof leaves[0][key] === "number" && key !== "year") {
                  var agg = averages[key] || "sum";
                  if (typeof agg === "function") {
                    d[key] = agg(leaves);
                  }
                  else {
                    d[key] = d3[agg](leaves, function(a){ return a[key]; });
                  }
                }
              }

              leaves.forEach(function(leaf){
                for (key in leaf) {
                  if (key != "bra_id" && key != out+"_id" && key != "school_type_id") {
                    if (leaf.bra_id == app.build.bra[0].id) var k = "cp_bra_0_"+key;
                    else if (leaf.bra_id == app.build.bra[1].id) var k = "cp_bra_1_"+key;
                    d[k] = leaf[key]
                  }
                }
              })

              // get_keys(d)

              data_obj.push(d)

            }
          })
          .entries(data.raw)

      }
      else if (out === "balance") {

          if (app.build.bra[0].id === "all") {
            var new_data = [];
            d3.nest()
              .key(function(d){ return d.year; })
              .key(function(d){ return d.month; })
              .rollup(function(leaves){
                var temp = {};
                for (var key in leaves[0]) {
                  if (key === "bra_id") {
                    temp[key] = "sabra";
                  }
                  else if (key === "month" || key === "year") {
                    temp[key] = leaves[0][key];
                  }
                  else {
                    var vals = leaves.filter(function(d){ return d[key] !== null; });
                    if (vals.length) {
                      temp[key] = d3.sum(vals, function(d){ return d[key]; });
                    }
                    else {
                      temp[key] = null;
                    }
                  }
                }
                temp.export_val_kg = temp.export_kg ? temp.export_val/temp.export_kg : 0;
                temp.import_val_kg = temp.import_kg ? temp.import_val/temp.import_kg : 0;
                new_data.push(temp);
                return leaves;
              })
              .entries(data.raw);
          }
          else {
            var new_data = data.raw;
          }

          new_data.forEach(function(d){

            var exp = d3plus.util.copy(d);
            exp.trade_balance = "trade_balance";
            exp.val_usd = exp.export_val || 0;
            exp.direction = "export_val";
            exp.icon = "/static/img/icons/balance/export_val.png"
            exp.color = "#0b1097";
            // get_keys(exp);
            for (var k in exp) {
              if (k.indexOf("import") === 0) {
                delete exp[k];
              }
            }
            data_obj.push(exp);

            var imp = d3plus.util.copy(d);
            imp.trade_balance = "trade_balance";
            imp.val_usd = imp.import_val || 0;
            imp.direction = "import_val";
            imp.icon = "/static/img/icons/balance/import_val.png"
            imp.color = "#af1f24";
            // get_keys(imp);
            // for (var k in imp) {
            //   if (k.indexOf("export") === 0) {
            //     delete imp[k];
            //   }
            // }
            data_obj.push(imp);

          })

      }
      else if (out === "time") {

        var time_periods = {
          "morning": "#f7b6d2",
          "afternoon": "#ffc41c",
          "night": "#2f2f6d",
          "full_time": "#105b10"
        };

        var time_order = {
          "morning": 1,
          "afternoon": 2,
          "night": 3,
          "full_time": 4
        }

        data.raw.forEach(function(d){

          for (var p in time_periods) {
            data_obj.push({
              "color": time_periods[p],
              "icon": "/static/img/icons/time/time_"+p+".png",
              "name": dataviva.format.text(p),
              "time_period": time_order[p],
              "students": d[p],
              "year": d.year
            })
          }

        })

      }
      else if (out === "type") {

        var student_types = {
          "enrolled": "#1abbee",
          // "students": "#ffc41c",
          "graduates": "#742777",
          "entrants": "#105b10"
        };

        data.raw.forEach(function(d){

          for (var p in student_types) {
            data_obj.push({
              "color": student_types[p],
              // "icon": "/static/img/icons/time/time_"+p+".png",
              "name": dataviva.format.text(p),
              "student_type": p,
              "students": d[p],
              "year": d.year
            })
          }

        })

      }
      else {

        data.raw.forEach(function(d){

          var obj = d

          obj[out+"_display"] = dataviva.displayID(obj[out+"_id"],out)

          obj.bra_rca = obj.rca >=1 ? true : false;
          obj.wld_rca = obj.rca_wld >=1 ? true : false;

          // get_keys(obj)

          data_obj.push(obj)

        })

      }

      data[format[app.build.app.type]] = data_obj;

      // function get_keys(d) {
      //   if (!data.categories) data.categories = {}
      //   if (!data.categories[d.year]) data.categories[d.year] = []
      //   if (!data.categories.all) data.categories.all = []
      //   if (out !== "all") var parent = d[out+"_id"].slice(0,depths[out][0])
      //   if (data.categories[d.year].indexOf(parent) < 0) data.categories[d.year].push(parent);
      //   if (data.categories.all.indexOf(parent) < 0) data.categories.all.push(parent);
      // }

    }

    app.total = function() {

      var exclusions = [
            "eci",
            "pci",
            "unique_cnae",
            "unique_cbo",
            "none",
            "importance",
            "wage_avg",
            "wage_avg_bra",
            "required_wage_avg",
            undefined
          ],
          val = app.vars.size

      if (exclusions.indexOf(val) >= 0) return false;

      var prefix = dataviva.format.text(val)
      if (app.build.app.type == "scatter") {
        var prefix = dataviva.format.text(app.build.output_attr+"_plural")
        prefix += " "+dataviva.format.text("with")
        prefix += " "+dataviva.format.text(app.vars.x)
        if (app.vars.x != app.vars.y) {
          prefix += " "+dataviva.format.text("and")
          prefix += " "+dataviva.format.text(app.vars.y)
        }
        if (app.build.output_attr != "hs") {
          prefix += " ("+dataviva.format.text(val)+")"
        }
      }
      prefix += ": "

      return {"prefix": prefix, "suffix": ""};

    }

    app.star = function(status) {

      function update_star(s) {
        d3.select("#starred > i")
          .attr("id","status_"+s)
          .attr("class",function() {
            return s == 1 ? "fa fa-star" : "fa fa-star-o";
          })
      }

      if ( status !== undefined ) {
        update_star(status)
      }
      else if ( "{{g.user.is_authenticated}}" === "False" ) {
        login()
      }
      else {

        var id = d3.select("#starred > i").attr("id")
          , current_status = parseInt(id.split("_")[1],10)

        d3.select("#starred > i")
          .attr("class",function(){
            return this.className + " fa fa-spin"
          })

        var url = window.location.pathname.replace("embed","star")

        d3.json(url)
          .header("Content-type","application/x-www-form-urlencoded")
          .post("title="+app.build.title, function(error,data) {
            if (data.success) {
              update_star(data.success)
            }
            else {
              update_star(current_status)
            }
          })

      }

    }

    app.download = function(obj) {

      var type = obj.id,
          title = app.build.app.name+"-"+app.build.title,
          columns = [],
          formattedColumns = []

      for (cat in app.tooltip.long) {
        app.tooltip.long[cat].forEach(function(k){
          columns.push(k)
        })
      }

      title = title.removeAccents().split(" ").join("_")

      var form = document.getElementById("svgform");

      if(type == "csv"){
        app.viz.csv(true);
        // CSV is generated on the client and finishes synchronously
        downloadDone();
      }
      else {

        if (app.build.app.type == "geo_map") var svg = d3.select("div#map svg")
        else var svg = d3.select("#app > svg")
        // Add necessary name space junk and get raw node
        svg.attr("version", 1.1)
          .attr("xmlns", "http://www.w3.org/2000/svg")
          .node()
        svg.insert('defs',":first-child")
        // Extract the data as SVG text string

        var svg_xml = (new XMLSerializer).serializeToString(svg.node());

        if (type == "png" || type == "pdf"){
            var style = "\n";
            var requiredSheets = ['phylogram_d3.css', 'open_sans.css'];
            for (var i=0; i<document.styleSheets.length; i++) {
              var sheet = document.styleSheets[i];
              if (sheet.href) {
                var sheetName = sheet.href.split('/').pop();
                if (requiredSheets.indexOf(sheetName) != -1) {
                  var rules = sheet.rules;
                  if (rules) {
                    for (var j=0; j<rules.length; j++) {
                      style += (rules[j].cssText + '\n');
                    }
                  }
                }
              }
            }

            img = new Image(),

            d3.select("svg defs")
                .append('style')
                .attr('type','text/css')
                .html(style);

            img.src = 'data:image/svg+xml;base64,'+window.btoa(unescape(encodeURIComponent(svg_xml)));

            var canvas = document.createElement("canvas");
            document.body.appendChild(canvas);

            var w = svg.node().getBBox().width,
                h = svg.node().getBBox().height;
                
            img.onload = function(){

              canvas.width = w;
              canvas.height = h;
              var context = canvas.getContext("2d")
              context.fillStyle = "white";
              context.fillRect(0,0,w,h);
              context.drawImage(img,0,0,w,h);

            if (type == "pdf"){
              w = w*0.264583333;
              h = h*0.264583333;
              pdf = new jsPDF('l', 'mm', [w, h]);
              pdf.addImage(canvas, 'JPEG', 0,0,w,h)
              pdf.save(title);
              downloadDone();
            } 
            else {
              img_download = canvas.toDataURL("image/png");
              var download = document.createElement('a');
              download.href = img_download;
              download.download = title + ".png";
              download.click();
              downloadDone();
            }
          }
        } 
        else{
          form['data'].value = svg_xml;
          // Submit the <FORM> to the server.
          // The result will be an attachment file to download.
          form['output_format'].value = type;
          form['title'].value = title;
          form['downloadToken'].value = new Date().getTime();
          csrf_token = document.getElementById("csrf_token").value;
          form['data'].value = form['data'].value.replace(/&/g, "%26")
          progress = 0

          d3.xhr("/{{g.locale}}/embed/download/")
          .header("Content-Type", "application/x-www-form-urlencoded")
          .post("output_format="+type+"&title="+ title+"&downloadToken="+ new Date().getTime() +"&data="+ form['data'].value +"&csrf_token="+ csrf_token, function(e, data){
              urlFile = data.response
              window.location.href = urlFile
              downloadDone();
            }
          )
        }
      }
    }

    /*********************/
    /* Builder Functions */
    /*********************/

    var builder = {}
    // builder.outputs = function(builds) {
    //
    //   app.all_builds = builds
    //
    //   app.all_builds.forEach(function(build){
    //     d3.select("#output_"+build.app.type).remove()
    //   })
    //
    //   app.all_builds.forEach(function(build){
    //
    //     if (d3.select("#output_"+build.app.type).empty()) {
    //       dataviva.popover.create({
    //         "id": "output_"+build.app.type,
    //         "width": 600,
    //         "height": "80%",
    //         "color": build.app.color
    //       })
    //       d3.select("#output_"+build.app.type)
    //         .append("div").attr("class","scrolling_content")
    //     }
    //
    //     var box = d3.select("#output_"+build.app.type).select("div.scrolling_content")
    //
    //     if (box.select("."+build.dataset).empty()) {
    //       box.append("div")
    //         .attr("class",build.dataset+" output_list")
    //         .append("div")
    //           .attr("class","title")
    //           .text(dataviva.format.text(build.dataset))
    //     }
    //
    //     if (build.url == app.build.url) var c = "decision"
    //     else var c = "help"
    //
    //     box.select("."+build.dataset).append("div")
    //       .attr("id",build.url)
    //       .attr("class","output "+c+" short icon "+build.app.type)
    //       .html(build.title)
    //       .on(d3plus.client.pointer.click,function(){
    //         app.start(this.id)
    //       })
    //
    //   })
    //
    //   if (d3.selectAll("#output_"+app.build.app.type+" .output")[0].length == 1) {
    //     d3.select("#output").style("display","none")
    //   }
    //   else {
    //     d3.select("#output").style("display","inline-block")
    //   }
    //
    // }

    builder.filter = function(obj,id,static) {

      var type = id.slice(0,id.length-2),
          index = id.slice(-1),
          old_obj = app.build[type][index]
          new_name = obj.name ? obj.name : obj["name_"+dataviva.language]

      if (type == "bra") {
        var url_index = 2
      }
      else if (["hs","cnae"].indexOf(type) >= 0) {
        var url_index = 3
      }
      else {
        var url_index = 4
      }

      app.build[type][index] = obj

      var url = app.url.split("/")
      var ids = url[url_index].split("_")
      if (obj.distance && obj.distance > 0) {
        ids[index] = obj.id+"."+obj.distance
      }
      else {
        ids[index] = obj.id
      }
      url[url_index] = ids.join("_")
      url = url.join("/")

      var button = d3.select("#"+id)

      if (type == "bra" && !obj.distance) obj.distance = 0

      if (!obj.icon) obj.icon = dataviva.icon(obj.id,type)

      button.select(".icon")
       .style("background-image","url("+obj.icon+")")

      if (["wld","bra"].indexOf(type) < 0 || (type == "wld" && obj.id.length != 5)) {
        button.select(".icon").style("background-color",obj.color)
      }
      else {
        button.select(".icon").style("background-color","rgba(0,0,0,0)")
      }

      if (obj.distance > 0 && type == "bra") new_name += " "+obj.distance+"km"

      button.select(".list_text").text(new_name)

      if (!static) {
        app.start(url)
      }

    }

    // builder.app = function(app_name,static) {
    //
    //   document.getElementById("app_select").value = app_name
    //
    //   var options = d3.select("#output_"+app_name).selectAll(".output")
    //
    //   if (options[0].length > 1) {
    //     d3.select("#output").style("display","inline-block")
    //   }
    //   else {
    //     d3.select("#output").style("display","none")
    //   }
    //
    //   if (!static) {
    //
    //     var match = null, backup = null, backup2 = null
    //
    //     options
    //       .each(function(d){
    //         var a = app.url.split("/")
    //         var s = this.id.split("/")
    //         if (!backup && s[s.length-2] == a[a.length-2] && s[1] == a[1]) backup = this.id
    //         if (!backup2 && s[1] == a[1]) backup2 = this.id
    //         a.shift()
    //         a = a.join("/")
    //         s.shift()
    //         s = s.join("/")
    //         if (a == s) match = this.id
    //       })
    //
    //     if (match === null) {
    //       if (backup) match = backup
    //       else if (backup2) match = backup2
    //       else match = options[0][0].id
    //     }
    //
    //     app.start(match)
    //   }
    //
    // }

    builder.url = function() {

      var doc_title = app.build.app.name+" : "+app.build.title
      dataviva.url("/{{g.locale}}/embed/"+app.url,app.vars,doc_title)

    }

    builder.controls = function() {

      if (app.vars.controls == "false") {
        app.vars.controls = "true"
      } else {
        app.vars.controls = "false"
      }
      builder.url()
      dataviva.resize()

    }

    builder.selector = function(id) {

      if (id == "output") {

        dataviva.popover.show("#output_"+app.build.app.type)

      }
      else if (id == "help") {

        var pid = "#help_"+app.build.app.type

        if (d3.select(pid).empty()) {

          dataviva.popover.create({
            "id": "help_"+app.build.app.type,
            "width": "80%",
            "height": "90%",
            "color": app.build.app.color,
            "close": true
          })

          d3.select(pid).append("iframe")
            .attr("width","100%")
            .attr("height","100%")
            .attr("src","/{{g.locale}}/embed/info/"+app.build.app.type+"/")

        }

        dataviva.popover.show(pid)

      }
      else if (id == "share") {

        var pid = "#share_info"

        if (d3.select(pid).empty()) {

          dataviva.popover.create({
            "id": "share_info",
            "width": "40%",
            "height": "250px",
            "color": app.build.app.color,
            "close": true
          })

          if(same_origin && window.location != window.parent.location){
            var url = encodeURIComponent(window.parent.location.pathname + window.parent.location.search)
          }
          else {
            var url = encodeURIComponent(window.location.pathname + window.location.search)
          }

          d3.json("/{{g.locale}}/embed/shorten/")
            .header("Content-type","application/x-www-form-urlencoded")
            .post("url="+url, function(error,data) {
              if (data.error) {
                alert(data.error)
              }
              else{

                d3.select(pid).append("h3")
                  .text(dataviva.format.text("share_url"))

                // make input box with share link

                var share_url = window.location.origin + "/" + dataviva.language + "/" + data.slug + "/";
                d3.select(pid).append("input")
                  .attr("type", "text")
                  .attr("class", "leon textbox mediumleon textbox large")
                  .attr("value", share_url)
                  .on(d3plus.client.pointer.click, function(){
                    this.focus();
                    this.select();
                  })

                d3.select(pid).append("h3")
                  .text(dataviva.format.text("embed_url"))
  
                // make input box with embed iframe
                d3.select(pid).append("input")
                  .attr("type", "text")
                  .attr("class", "leon textbox mediumleon textbox large")
                  .attr("value", "<iframe width='560' height='315' src='"+window.location.href+"' frameborder='0'></iframe>")
                  .on(d3plus.client.pointer.click, function(){
                    this.focus();
                    this.select();
                  })

                d3.select(pid).append("h3")
                  .text(dataviva.format.text("social_media"))

                var category_name = document.referrer.split('/')[4];
                var category_id = document.referrer.split('/')[5];
                var url_image =  dataviva.s3_host+"/img/"+category_name+"/"+category_name+"_"+category_id+".jpg"
                var share_url = window.location.origin + "/" + dataviva.language + "/" + data.slug + "/";

                $.ajax({
                    url: '/embed/image?link=' + url_image,
                    type:'GET',
                    success: function(request, status){

                      if(request != "200"){
                        url_image =  dataviva.s3_host+"/img/"+category_name+"/"+category_name+"_all.jpg"
                      }

                      // Twitter link
                      d3.select(pid).append("a")
                        .attr("href", "https://twitter.com/share?url="+share_url+"&text="+app.viz.title()+"&hashtags=dataviva")
                        .attr("class", "share_button")
                        .attr("target", "_blank")
                        .attr("onclick", "return !window.open(this.href, 'Twitter', 'width=640,height=300')")
                        .attr("id", "Twitter")
                        .attr("title", function(){
                          return dataviva.language == "pt" ? "Tweetar" : "Tweet";
                        })

                      // Facebook link
                      var description = "{{ _('DataViva is opening up data for the entire formal sector of the Brazilian economy') }}"
                      description += " "
                      description += "{{ _('through more than 100 million interactive visualizations.') }}"
                      d3.select(pid).append("a")
                        .attr("href", "http://www.facebook.com/dialog/feed?display=popup&app_id={{facebook_id}}&description="+description+"&name="+app.viz.title()+"&link="+share_url+"&picture="+url_image+"&redirect_uri="+window.location.origin+"/close/")
                        .attr("class", "share_button")
                        .attr("target", "_blank")
                        .attr("onclick", "return !window.open(this.href, 'Facebook', 'width=640,height=300')")
                        .attr("id", "Facebook")
                        .attr("title", "Facebook")

                      // Google link
                      d3.select(pid).append("a")
                        .attr("href", function(){
                          var lang = dataviva.language == "pt" ? "pt-BR" : "en-US";
                          return "https://plus.google.com/share?url=" + share_url + "&hl=" + lang
                        })
                        .attr("class", "share_button")
                        .attr("target", "_blank")
                        .attr("onclick", "return !window.open(this.href, 'Google+', 'width=640,height=300')")
                        .attr("id", "Google")
                        .attr("title", "Google+")
                    }
                });

              }
            })

        }

        dataviva.popover.show(pid)

      }
      else {

        var type = id.slice(0,id.length-2);
        var index = id.slice(-1);

        // if (type == "file") {
          var init = "all",
              callback = app.download,
              dist = 0
        // }
        // else {
        //   var init = app.build[type][index].id,
        //       callback = builder.filter
        //
        //   if (type == "bra" && app.build.bra[index].distance) {
        //     var dist = app.build.bra[index].distance
        //   }
        //   else {
        //     var dist = 0
        //   }
        //
        // }

        selector
          .callback(callback)
          .distance(dist)
          .initial_value(init)
          .type(id);

        d3.select("#popover")
          .call(selector);

        // Show popover
        dataviva.popover.show("#popover");

      }

    }

    /*****************/
    /* Page Resizing */
    /*****************/

    dataviva.resize = function(noDraw) {

      if (window.innerWidth < 500 || window.innerHeight < 400) {
        app.vars.controls = "false";
        d3.select("#settings").style("display","none");
        d3.select("#controls").style("display","none");
        app.viz.tooltip({"html": false, "children": false})
          .title({"font": {"size": 16}})
          .y({"label": {"font": {"size": app.build.app.type === "compare" ? 12 : 16 }}})
          .y({"ticks": {"font": {"size": 12}}})
          .x({"label": {"font": {"size": app.build.app.type === "compare" ? 12 : 16 }}})
          .x({"ticks": {"font": {"size": 12}}});
      }
      else {
        d3.select("#settings").style("display","block");
        d3.select("#controls").style("display","block");
        app.viz.tooltip({"html": app.html, "children": true})
          .title({"font": {"size": 22}})
          .y({"label": {"font": {"size": app.build.app.type === "compare" ? 16 : 22 }}})
          .y({"ticks": {"font": {"size": 16}}})
          .x({"label": {"font": {"size": app.build.app.type === "compare" ? 16 : 22 }}})
          .x({"ticks": {"font": {"size": app.build.output === "age" || app.build.app.type === "bar" ? 12 : 16}}});
      }

      // Set the max-width for the builder div and app_title
      d3.select("#controls").style("max-width",window.innerWidth+"px")
      app.title_width = window.innerWidth - 20
      app.title_width -= d3.select("#settings").node().offsetWidth

      d3.selectAll("#controls > br").remove()

      var total_width = 0,
          settings_width = d3.select("#settings").node().offsetWidth,
          avail_width = window.innerWidth - settings_width;

      // d3.selectAll("#controls > div")
      //   .each(function(){
      //     total_width += this.offsetWidth
      //   })
      //
      // if (total_width > avail_width) {
      //
      //   var w = 0
      //
      //   d3.selectAll("#controls > div")
      //     .each(function(){
      //       if (w > avail_width/2) {
      //         w = 0
      //         var br = document.createElement("br")
      //         this.parentNode.insertBefore(br,this)
      //       }
      //       w += this.offsetWidth
      //     })
      // }

      // if (app.vars.controls == "true") {
      //   app.title_width = window.innerWidth
      //   d3.select("#controls_toggle").attr("class","leon button square active")
      //   app.title_height = d3.select("#settings").node().offsetHeight
      //   var buffer = 0
      // }
      // else {
      //   app.title_width = window.innerWidth - d3.select("#settings").node().offsetWidth
      //   d3.select("#controls_toggle").attr("class","leon button square")
      //   if (app.title_width < 200) {
      //     app.title_width = window.innerWidth
      //     var buffer = d3.select("#settings").node().offsetHeight
      //   }
      //   else {
      //     var buffer = 0
      //   }
      // }

      if (d3.select("#key").node() && app.categories && app.categories.length > 1) {
        d3.select("#key").style("display","inline-block")
        if (window.innerWidth < d3.select("#key").node().offsetWidth-10) {
          d3.select("#key").style("display","none")
        }
      }

      if (d3.select("#year_slider").node()) {
        d3.select("#year_slider").style("display","inline-block")
        if (window.innerWidth < d3.select("#year_slider").node().offsetWidth-10) {
          d3.select("#year_slider").style("display","none")
        }
      }

      app.height = window.innerHeight-10;
      if (app.vars.controls != "false") app.height -= d3.select("#controls").node().offsetHeight
      app.width = window.innerWidth-10;

      // d3.select("#controls").style("bottom",function(d){
      //   if (app.vars.controls != "false") var u = 0
      //   else var u = 1
      //   return "-"+((this.offsetHeight+5)*u)+"px"
      // })

      d3.select("#app")
        .style("height",app.height+"px")
        .style("width",app.width+"px")

      app.viz
        .height(app.height)
        .width(app.width)
        .title({
          "height": app.title_height,
          "width": app.title_width
        })

      if (!noDraw) {
        app.viz.draw();
      }

      if (!app.first_load) {
        d3.select("#app")
          .style("-webkit-transition","height 0.6s")
          .style("transition","height 0.6s")
        // d3.select("#controls")
        //   .style("-webkit-transition","bottom 0.6s")
        //   .style("transition","bottom 0.6s")
      }

    }

    /************************/
    /* Initialize First App */
    /************************/
    var attrs = d3.keys(depths);
    function load_attr() {
      if (attrs.length) {
        var a = attrs.pop();
        var url = "/attrs/"+a+"/?lang="+dataviva.language;
        localforage.getItem(url,function(error, data){
          if (data) app.attrs[a] = cleanAttrs(data, a);
          load_attr();
        });
      }
      else {
        app.start();
      }
    }
    localforage.getItem("version", function(error, version){

      if (error || version !== dataviva.attr_version) {
        localforage.clear(function(){
          localforage.setItem("version", dataviva.attr_version);
          load_attr();
        })
      }
      else {
        load_attr();
      }
    })

    if (Modernizr.history) {
     window.onpopstate = function() {
       if (app.first_load) {
         var u = window.location.href.split("/embed/")[1].split("/?")[0]
         u = u.replace(/\/+$/, "")+"/"
         if (u != app.url) app.start(u)
       }
     }
    }

  </script>


    <!-- Google Analytics! -->
    <script>

      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42576717-1', 'auto');
      ga('send', 'pageview');

      if ("{{g.page_type}}" !== "home") dataviva.ui.background();

      if (dataviva.resize) {
        var bg_resize = window.onresize
        window.onresize = function() {
          if (dataviva.resize_snap) dataviva.resize()
          else {
            if(this.resizeTO) clearTimeout(this.resizeTO);
            this.resizeTO = setTimeout(function() {
              dataviva.resize()
            },500)
          }
          if (bg_resize) bg_resize()
        }
      }

    </script>

  </body>
</html>
