<!-- extend from base layout -->
{% extends "templates/base.html" %}

{% block content %}

  <div id="header_container" class="lightbox">
    <div id="header">
   
    <div class="searchBox">
    	
	    	<input type="text" autocomplete="false" name="searchFld_1" id="searchFld" class="searchFld"  placeholder="{%trans%}Search by Location, Occupation, etc..{%endtrans%}">
    	
    	<a id="search" href="#" class="link">{%trans%}Search{%endtrans%}</a>
    	<div class="searchResult">
    		
    	</div>
    </div>
      <a id="logo" href="{{ url_for('general.home') }}"></a>
      <a id="apps" href="{{ url_for('apps.guide') }}" class="link{% if g.page_type == 'apps' or g.page_type == 'builder' %} active{% endif %}">{% trans %}Apps{% endtrans %}</a>
      <a id="profiles" href="{{ url_for('profiles.index') }}" class="link{% if g.page_type == 'profiles' or g.page_type == 'profile' %} active{% endif %}">{% trans %}Profiles{% endtrans %}</a>
      <a id="guide" href="{{ url_for('guide.guide') }}" class="link{% if g.page_type == 'guide' or g.page_type == 'plan' %} active{% endif %}">{% trans %}Guide{% endtrans %}</a>
      <a id="data" href="{{ url_for('data.index') }}" class="link{% if g.page_type == 'data' or g.page_type == 'query' or g.page_type == 'classifications' %} active{% endif %}">{% trans %}Data{% endtrans %}</a>
      <a id="rankings" href="{{ url_for('rankings.index') }}" class="link{% if g.page_type == 'rankings' %} active{% endif %}">{% trans %}Rankings{% endtrans %}</a>
      <a id="about" href="{{ url_for('about.contact') }}" class="link{% if g.page_type == 'about' %} active{% endif %}">{% trans %}Learn More{% endtrans %}</a>
      
      <div id="nav_controls">
        
        <div id="account">
          {% if g.user.is_authenticated() %}
            {{ g.user.nickname }}
          {% else %}
            {% trans %}Login{% endtrans %}
          {% endif %}
        </div>
      
        <div id="language">
          <input type="radio" name="language_select" onclick="change_language(this.value)" 
            id="en" value="en"{% if g.locale == 'en' %} checked{% endif %}>
          <label for="en">en</label>
          <input type="radio" name="language_select" onclick="change_language(this.value)" 
            id="pt" value="pt"{% if g.locale == 'pt' %} checked{% endif %}>
          <label for="pt">pt</label>
        </div>
        
        
      </div>
		
      {% if g.user.is_authenticated() %}
      <div id="account_tooltip" style="display:none;">
        <a class="account" href="{{ url_for('account.user', nickname=g.user.nickname) }}"><i class="fa fa-user"></i>{% trans %}Profile{% endtrans %}</a>
        {% if g.user.is_admin() %}
          <a class="account" href="{{ url_for('admin.admin') }}"><i class="fa fa-cogs"></i>{% trans %}Admin Panel{% endtrans %}</a>
        {% endif %}
        <a class="account" href="{{ url_for('account.logout') }}"><i class="fa fa-key"></i>{% trans %}Logout{% endtrans %}</a>
        
      </div>
      {% endif %}
    
    </div>
    
  </div>
      
  {% if crumbs|length %}
    <div id="breadcrumbs">
      {% for crumb in crumbs %}
        {% if crumb.current %}
          <div class="decision short">{{ crumb.text }}</div>
        {% else %}
          <a href="{{ crumb.url }}" class="help short">{{ crumb.text }}</a>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
  
  <div id="fullscreen"></div>

  <div id="outer_container">
    <div id="inner_container">
      <div id="container">

        {% for category, msg in get_flashed_messages(with_categories=true) %}
        <div id="server_message">
          <div class="decision flash-{{ category }}">
            {{ msg|safe }}
            <i id="close_message" class="fa fa-times-circle"></i>
          </div>
        </div>
        {% endfor %}
    
        {% block body %}
        {% endblock %}

      </div>
    </div>
  </div>
  
  <div id="nav_footer" class="lightbox">
    
    <!-- Open Data Link -->
    <a class="opendata" href="http://opendefinition.org/">
      <img alt="This material is Open Data" border="0"
      src="http://assets.okfn.org/images/ok_buttons/od_80x15_red_green.png" />
    </a>
    <!-- /Open Data Link -->
    
    <a href="http://www.fjp.gov.br/" class="logo fjp" target="_blank"></a>
    <a href="http://www.fapemig.br/" class="logo fapemig" target="_blank"></a>
    <a href="http://www.escritorio.mg.gov.br/" class="logo governo" target="_blank"></a>
    
    
  </div>
  
  <div class="survey-block">
  	{% if g.locale == 'pt' %}
  	<img src="/static/img/icons/app/pesquisa2.png">
  	{% else %}
  	<img src="/static/img/icons/app/pesquisa.png">
  	{% endif %}
  	<div class="survey-body">
  		<h2>{%trans%}Dear user,{%endtrans%}</h2>
		{%trans%}In order to improve our platform, we are running a very quick survey to collect some impressions and to know more about our users.{%endtrans%}
		<br><br>
		{%trans%}The estimated time to answer is about 2 to 3 minutes and there is no identification.{%endtrans%}
		<br><br>
		{%trans%}Thanks a lot, DataViva Team.{%endtrans%}
		<br><br>
		{% if g.locale == 'pt' %}
		<a href="https://pt.surveymonkey.com/s/M6TR9SG" target="_blank">{%trans%}PARTICIPAR DA PESQUISA{%endtrans%}</a>
		{% else %}
		<a href="https://pt.surveymonkey.com/s/MWZ97WG" target="_blank">{%trans%}TAKE THE SURVEY{%endtrans%}</a>
		{% endif %}
		<br><br>
		
  	</div>
  </div>
  
  <script type="text/javascript">
  
    var crumbs = "{{crumbs|safe}}"
  
    function change_language(l) {
      window.location = "/set_lang/" + l + "/?next=" + window.location.pathname;
    }
    
    leon("$language_select").color("{{ g.color }}").size("small")
        
    d3.select("#close_message").on(d3plus.evt.click,function(){
      var div = d3.select("#server_message")
      var timing = parseFloat(div.style("transition-duration"),10)*1000;
      div.style("opacity",0);
      setTimeout(function(){
        div.remove();
      },timing)
    });
    
    if ("{{ g.user.is_authenticated() }}" != "False") {
    
      show_toggle = function() {
        d3.select("#account").attr("class","active")
        d3.select("#d3plus_tooltip_id_account").style("display","block")
      }
    
      hide_toggle = function() {
        d3.select("#account").attr("class","")
        d3.select("#d3plus_tooltip_id_account").style("display","none")
      }
    
      var language_html = d3.select("div#account_tooltip").html()
      d3.select("div#account_tooltip").remove()
    
      var acct = d3.select("#account").node(),
          w = acct.offsetWidth,
          h = acct.offsetHeight,
          x = acct.offsetLeft+w/2,
          y = acct.offsetTop+h
        
      d3plus.tooltip.create({
        "id": "account",
        "x": x,
        "y": y,
        "arrow": true,
        "align": "bottom center",
        "mouseevents": true,
        "html": language_html,
        "width": "auto"
      })

      d3.select("#d3plus_tooltip_id_account")
        .style("display","none")
        .on(d3plus.evt.click,function(){
          d3.event.stopPropagation()
        })
    
      d3.select("#account").on(d3plus.evt.click,function(){
        if (this.className.indexOf("active") < 0) {
          show_toggle()
        }
        else {
          hide_toggle()
        }
        d3.event.stopPropagation()
      })
    
      d3.select("body").on(d3plus.evt.click,function(){
        hide_toggle()
      })
    
    }
    else {
      d3.select("#account").on(d3plus.evt.click,function(){
        login()
      })
    }
    d3.select(".survey-block img").on("click", function(){
    	if(this.getAttribute("open")==1) {
	    	d3.select(this.parentNode).transition().style("bottom", "-322px");
	    	d3.select(this).attr("open", 0)
    	} else {
    		d3.select(this.parentNode).transition().style("bottom", "0px");
    		d3.select(this).attr("open", 1)
    	}
    })
    
     d3.select("a#search").on(d3plus.evt.click, function() {
     	d3.select(this.parentNode).transition().style("width", "490px");
     	d3.event.preventDefault();
     })
    
    d3.select(window).on(d3plus.evt.click, function() {
    	d3_target = d3.select(d3.event.target);   
        if (!d3_target.classed("searchFld")&&!d3_target.classed("link")&&!d3_target.classed("searchBtn")&&!d3_target.classed("searchBox")) {
            //d3.event.preventDefault();
            if(d3.select(".searchBox").style("width")=="490px") {
            	d3.select(".searchResult").style("display", "none").transition().style("opacity", 0).each("end", function() { 
            		this.innerHTML = "";
            		document.getElementById("searchFld").value = "";
            	});
            	d3.select(".searchBox").transition().style("width", "41px");
           }
        }
    })
    var searchInterval = "";
    d3.select(".searchFld").on("keyup", function() {
    	clearInterval(searchInterval);
    	
    	//d3.select(".fa-search").attr("class", "fa fa-spinner fa-spin")
    	searchInterval = setTimeout(function(){
    		d3.select(".searchResult").style("display", "block").transition().delay(0).style("opacity", 1);
    		find_search(document.getElementById(d3.select(".searchFld").attr("id")).value)
    		//d3.select(".fa-spinner").attr("class", "fa fa-search")
    	},300)
    })
  find_search = function(search) {
  	if(search != "") {
	    d3.json("/attrs/search/"+search+"/")
	      .header("Content-type", "application/json")
	      .send("GET", '', function(error, text) { 
	       litems = "";
	        type_curr = ""
	       for(var result in text.activities) {
	       	item = text.activities[result]
	       	urlSearch = item.content_type+"/"+item.id;
	       	exclude = false;
	       
	       	if (typeof item.content_type !== "undefined") {
	       		item.bg = item.color
	       		
		       	if(item.content_type == "bra") {
		       		item_type = "Location"
		       		if(item.id.length > 6) {
		       			type = "(Cidade)"
		      		} else if(item.id.length == 4){
		      			type = "(Mesoregião)"
		       		} else if(item.id.length > 4 && item.id.length <= 6)  {
		       			exclude = true;
		       		} else {
		       			type = "(Estado)"
		       		}
		       		
		       		item.bg = "transparent";
		       		if(item.id!="bra") {
		       			icon = item.id.substr(0,2);
		       		} else {
		       			icon = "all";
		       		}
		       	}
		       	
		       	if(item.content_type == "cbo") {
		       		item_type = "Occupation"
		       		if(item.id.length == 1) {
		       			type = "(Grande Grupo)"
		       			icon = item.id
		       		} else if (item.id.length == 4) {
		       			type = "(Família)"
		       			icon = item.id.substr(0,1)
		       		} else {
		       			exclude = true;
		       		} 
		       	}
		       	
		       	if(item.content_type == "isic") {
		       		item_type = "Industry"
		       			type = ""
		       			icon = item.id		
		       	}
		       	
		       	if(item.content_type == "hs") {
		       		item_type = "product_export"
		       		if(item.id.length == 2) {
		       			type = "(Seção)"
		       			icon = item.id
		       		} else if (item.id.length == 6) {
		       			type = "(Posição)"
		       			icon = item.id.substr(0,2)
		       		} else {
		       			exclude = true;
		       			
		       		} 
		       	}
		       	
		       	if(item.content_type == "wld") {
		       		item_type = "export_destination"
		       		if(item.id.length == 2) {
		       			type = "(Continente)"
		       			icon = item.id
		       		} else {
		       			item.bg = "transparent";
		       			type = "(País)"
		       			icon = item.id
		       		} 
		       	}
		       	
		       	if(!exclude) {
		       		if(type_curr!=item.content_type) {
		       			//console.log("passou");
		       			if(type_curr!="") { litems += "</div>" }
		       			
		       			litems += "<div class='search_ct'> \
		       							<div class='search_qd'> \
		       							<div class='search_esq'>"
		       			litems += dataviva.format.text(item_type);
		       			litems += " \
		       							</div><div class='search_dir'>"
		       			type_curr = item.content_type
		       		}
		       		litems += "<a target='_blank' href='http://dataviva.info/profiles/"+urlSearch+"' class='searchLink'> \
		       						<div class='searchIcon' style='background-image: url(/static/img/icons/"+item.content_type+"/"+item.content_type+"_"+icon+".png); background-color: "+item.bg+";'></div> \
			       						<div class='searchText'> \
			       							<div class='search_title'>"+item.name+"</div> \
			       							<div class='searchType'>"+type+"</div> \
			       						</div>\
		       					</a>"
		       		//litems += "<a href='/profiles/"+urlSearch+"' style='display:inline-block; margin-bottom:5px; width:411px; border-left:6px solid "+item.color+"; padding: 7px 10px;'>"+item.name+"</a>"
		       	}
		       	
		       }
	       }
	       d3.select(".searchResult").html(litems);
	      });
      }
  }
  </script>
    
{% endblock %}