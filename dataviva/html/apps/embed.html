{% extends "templates/base.html" %}

{% block head %}

  <link type="text/css" rel="stylesheet" media="all" href="/static/css/styles.apps.css" />
  <link type="text/css" rel="stylesheet" media="all" href="/static/css/utils/utils.key.css" />

{% endblock %}


{% block content %}

  <div id="mask" class="loading"></div>

  <div id="builder">

    <select id="app_select" onchange="builder.app(this.options[this.selectedIndex].id)">
      {% set pre_app = None %}
      {% for build in all_builds %}

        {% if pre_app != build.app.type %}
          {% set pre_app = build.app.type %}
          <option icon="url('/static/img/icons/app/app_{{build.app.type}}.png')" color="{{build.app.color}}" value="{{build.app.type}}" id="{{build.app.type}}"{% if build.app.type == current_build.app.type %} selected="selected"{% endif %}>
              {{ build.app.name() }}
          </option>
        {% endif %}

      {% endfor %}
    </select>

    <div id="output" class="leon button medium" onclick="builder.selector(this.id)">
      <span class="list_text">{% trans %}Change Output{% endtrans %}</span>
      <i class="fa fa-list-alt"></i>
    </div>

    <div id="bra_0" class="leon button medium" onclick="builder.selector(this.id)">
      {% set bra = current_build.bra[0] %}
      <div class="leon icon medium" style="background-image:url('{{ bra.icon }}')"></div>
      <span class="list_text">{{ bra.name }}</span>
      <i class="fa fa-list-alt"></i>
    </div>

    {% if current_build.bra[1] %}
    {% set bra = current_build.bra[1] %}
    {% endif %}
    <div id="bra_1" class="leon button medium" onclick="builder.selector(this.id)">
      <div class="leon icon medium"{% if bra %} style="background-image:url('{{ bra.icon }}')"{% endif %}></div>
      <span class="list_text">{% if bra %}{{ bra.name }}{% endif %}</span>
      <i class="fa fa-list-alt"></i>
    </div>

    {% if current_build.cnae %}
    {% set cnae = current_build.cnae[0] %}
    {% endif %}
    <div id="cnae_0" class="leon button medium" onclick="builder.selector(this.id)">
      <div class="leon icon medium"{% if cnae %} style="background-color:{{ cnae.color }}; background-image:url('/static/img/icons/cnae/cnae_{{ cnae.id[:1] }}.png')"{% endif %}></div>
      <span class="list_text">{% if cnae %}{{ cnae.name }}{% endif %}</span>
      <i class="fa fa-list-alt"></i>
    </div>

    {% if current_build.cbo %}
    {% set cbo = current_build.cbo[0] %}
    {% endif %}
    <div id="cbo_0" class="leon button medium" onclick="builder.selector(this.id)">
      <div class="leon icon medium"{% if cbo %} style="background-color:{{ cbo.color }}; background-image:url('/static/img/icons/cbo/cbo_{{ cbo.id[:1] }}.png')"{% endif %}></div>
      <span class="list_text">{% if cbo %}{{ cbo.name }}{% endif %}</span>
      <i class="fa fa-list-alt"></i>
    </div>

    {% if current_build.hs %}
    {% set hs = current_build.hs[0] %}
    {% endif %}
    <div id="hs_0" class="leon button medium" onclick="builder.selector(this.id)">
      <div class="leon icon medium"{% if hs %} style="background-color:{{ hs.color }}; background-image:url('/static/img/icons/hs/hs_{{ hs.id[:2] }}.png')"{% endif %}></div>
      <span class="list_text">{% if hs %}{{ hs.name }}{% endif %}</span>
      <i class="fa fa-list-alt"></i>
    </div>

    {% if current_build.wld %}
    {% set wld = current_build.wld[0] %}
    {% endif %}
    <div id="wld_0" class="leon button medium" onclick="builder.selector(this.id)">
      <div class="leon icon medium"{% if wld %} style="{% if wld.id|count == 5 %}background-color:{{ wld.color }}; {% endif %}background-image:url('/static/img/icons/wld/wld_{{ wld.id }}.png')"{% endif %}></div>
      <span class="list_text">{% if wld %}{{ wld.name }}{% endif %}</span>
      <i class="fa fa-list-alt"></i>
    </div>

    <div id="app_controls"></div>

  </div>

  <div id="settings">

    <a id="refresh" class="leon button square alt_tooltip" onclick="app.start()" alt="{% trans %}Refresh the App{% endtrans %}"><i class="fa fa-refresh"></i></a>
    <a id="file" class="leon button square alt_tooltip" onclick="builder.selector(this.id)" alt="{% trans %}Download this App{% endtrans %}"><i class="fa fa-save"></i></a>
    <a id="starred" class="leon button square alt_tooltip" onclick="app.star()" alt="{% trans %}Save this App{% endtrans %}"><i id="status_{{starred}}" class="{% if starred == 1 %}fa fa-star{% else %}fa fa-star-o{% endif %}"></i></a>
    <a id="share" class="leon button square alt_tooltip" onclick="builder.selector(this.id)" alt="{% trans %}Share/Embed{% endtrans %}"><i class="fa fa-share"></i></a>
    <a id="help" class="leon button square alt_tooltip" onclick="builder.selector(this.id)" alt="{% trans %}Show App Tutorial{% endtrans %}"><i class="fa fa-question-circle"></i></a>
    <a id="full_screen" class="leon button square alt_tooltip" onclick="window.open(window.location.href,'_blank')" alt="{% trans %}Open App in Full-Screen{% endtrans %}"><i class="fa fa-arrows-alt"></i></a>
    <a id="controls_toggle" class="leon button square alt_tooltip" onclick="builder.controls()" alt="{% trans %}Show/Hide Controls{% endtrans %}"><i class="fa fa-cogs"></i></a>

  </div>

  <div id="app"></div>
  <div id="ui_bottom"></div>

  <!-- Hidden <FORM> to submit the SVG data to the server, which will convert it
       to SVG/PDF/PNG downloadable file. -->
  <form id="svgform" action="/apps/download/" method="post">
      {{ form.hidden_tag() }}
  </form>


{% endblock %}

{% block js %}

  <!--<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>-->
  <!--<script src="/static/js/libs/d3.geo.tile.js"></script>-->
  <script src="/static/js/libs/topojson.js"></script>
  <script src="/static/js/libs/queue.min.js"></script>
  <!--<script src="/static/js/libs/jfont-minified.js"></script>-->
  <script src="/static/js/utils/utils.key.js"></script>
  <script src="/static/js/utils/utils.selector.js"></script>

  <script>
  // Handling Cookies
  function getCookie( name ) {
    var parts = document.cookie.split(name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
  }

  function expireCookie( cName ) {
    document.cookie =
      encodeURIComponent( cName ) +
      "=deleted; expires=" +
      new Date( 0 ).toUTCString();
  }


  var downloadTimer;
  var attempts = 30;

  // Starts de verification if download is finished
  function checkDownloadIsDone() {
  	var token = document.getElementById("downloadToken").value;
	downloadTimer = window.setInterval( function() {
		downloadToken = new Date().getTime();
		//console.log(getCookie("downloadToken"));
		//console.log({tokennow: token, cookitoken: downloadToken})
		if( (token < downloadToken) || (attempts == 0) ) {
		  //downloadDone();
		}

      	attempts--;
    }, 1000 );
  }

	// Destrioy verification and hide the popover
  function downloadDone() {
    dataviva.popover.hide("#popover")
    window.clearInterval( downloadTimer );
    expireCookie( "downloadToken" );
  }
  </script>

  <script type="text/javascript">

    var max_year = {{ g.latest_year|safe }}

    var loading = new dataviva.ui.loading("body")
    loading.color("#ffffff")

    loading.text("Initializing App").show()

    d3.select("#mask").remove()

    // Check to see if parent window element is of same origin
    try {
      var same_origin = window.parent.location.host == window.location.host;
    }
    catch (e) {
      var same_origin = false
    }

    // App Data Formatting
    var format = {
      "occugrid": "occugrid",
      "compare": "compare",
      "geo_map": "default",
      "scatter": "default",
      "network": "default",
      "rings": "default",
      "tree_map": "default",
      "stacked": "default",
      "line": "default",
      "box": "default"
    }

    // Get various depth levels
    var depths = {
      "cnae": dataviva.depths("cnae"),
      "cbo": dataviva.depths("cbo"),
      "hs": dataviva.depths("hs"),
      "bra": dataviva.depths("bra"),
      "bra2": dataviva.depths("bra"),
      "wld": dataviva.depths("wld"),
      "university": dataviva.depths("university"),
      "course_hedu": dataviva.depths("course_hedu"),
      "course_sc": dataviva.depths("course_sc")
    }

    // Create Filter Selector
    var selector = Selector()

    dataviva.popover.create({
      "id": "popover",
      "width": 600,
      "height": "80%"
    })

    leon("#app_select")

    // Hide full-screen button while in full-screen
    if (same_origin && parent.location.pathname.indexOf("embed") >= 0) {
      d3.select("#full_screen").remove();
    }

    var footer = {
      "secex": dataviva.format.text("Data Provided by") + " SECEX",
      "secex_export": dataviva.format.text("Data Provided by") + " SECEX",
      "secex_import": dataviva.format.text("Data Provided by") + " SECEX",
      "rais": dataviva.format.text("Data Provided by") + " RAIS"
    }

    /*******************************/
    /* App Functions and Variables */
    /*******************************/

    var app = {}, last_app = null
    app.build = null
    app.url = "{{ current_build.url() }}"
    app.data = {}
    app.ecis = {}
    app.networks = {}
    app.coords = {}
    app.attrs = {}
    app.vars = {{ global_vars|safe }}
    app.solos = []
    app.filters = []
    app.first_load = false

    app.embed_footer = "<a href='http://www.dataviva.info' target='_blank'>"
    app.embed_footer += dataviva.format.text("View more visualizations on the full DataViva.info website.") + "</a>"

    if (app.vars.builder == "false") {
      app.vars.controls = "false"
      d3.select("#controls_toggle").remove()
    }

    // Set the max-width for the builder div and app_title
    app.title_width = window.innerWidth
    app.title_width -= d3.select("#settings").node().offsetWidth+12
    app.title_width -= d3.select("#settings").node().offsetWidth

    app.title_height = d3.select("#settings").node().offsetHeight+10

    app.font = null
    var fonts = ["HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", "Helvetica", "Arial", "sans-serif"]
    fonts.forEach(function(font){
      if (d3plus.font.validate(font) && !app.font) app.font = font
    })

    // app.loader_style = {
    //   "color": "#888",
    //   "font-size": "16px",
    //   "margin-top": "-11px",
    //   "text-shadow": "0px 0px 6px #efefef"
    // }

    app.html = function(id,list) {

      var obj = app.build.output !== "all" ? app.attrs[app.build.output][id] : false;

      if (app.build.app.type == "rings") {
        if (list) {
          var cats = []
          list.forEach(function(n){
            var id = n[app.build.output+"_id"].slice(0,depths[app.build.output][0])
            if (cats.indexOf(id) < 0) cats.push(id)
          })
          builder.key(cats)
        }
        var old_url = app.url
        var split_url = app.url.split("/")
        if (app.build.output == "cbo") var url_index = 4
        else var url_index = 3
        builder.filter(obj,app.build.output+"_0",true)
        split_url[url_index] = app.build[app.build.output][0].id
        app.url = split_url.join("/")
        if (app.url != old_url) {
          d3.json("/apps/embed/"+app.url)
            .header("X-Requested-With", "XMLHttpRequest")
            .get(function(error,data){
              app.build = data.current_build
              builder.url()
              builder.outputs(data.all_builds)
              app.viz.title(app.build.title).draw()
              // d3.select("#app").call(app.viz.title(app.build.title))
            })
        }
      }

      var priority = ["both_filters","filter2","filter1","no_filters"],
          html_return = "<div class='title'>"+dataviva.format.text("related_apps")+"</div>";

      priority.forEach(function(p,i){
        if (app.recommendations[p]) {

          if (["network","rings","geo_map"].indexOf(app.build.app.type) >= 0) {
            var classname = "decision short icon"
          }
          else {
            var classname = "decision icon"
          }

          app.recommendations[p].forEach(function(a){

            var u = a.url

            if (app.build.output !== "all") {
              u = u.replace("<"+app.build.output+">",id)
            }

            if ( u !== app.url ) {

              var t = a.title;

              if (obj) {

                t = t.replace("<"+app.build.output+">",obj.name)
                if (t.indexOf("<"+app.build.output+"_") >= 0) {
                  var article = t.match(new RegExp("<"+app.build.output+"_.*?>"))
                  var word = article[0]
                  article = article[0].split("_")[1].split(">")[0]
                  if (obj.article_pt) {
                    if (obj.gender_pt == "m") {
                      if (article == "em") var new_article = "no"
                      if (article == "de") var new_article = "do"
                      if (article == "para") var new_article = "para o"
                    }
                    else if (obj.gender_pt == "f") {
                      if (article == "em") var new_article = "na"
                      if (article == "de") var new_article = "da"
                      if (article == "para") var new_article = "para a"
                    }
                    if (obj.plural_pt) {
                      new_article += "s"
                    }
                  }
                  else {
                    var new_article = article
                  }
                  t = t.replace(word,new_article)
                }

              }

              html_return += "<div id='"+u+"' class='"+classname+" "+a.app.type+"' "
              html_return += "onclick='app.start(this.id)'>"
              html_return += t
              html_return += "</div>"

            }

          })
        }
      })

      return html_return

    }

    app.tooltip = {"short": {

      "":[],
      "basics":[],
      "calculations":[]

      }, "long": {

      "":[],
      "basics":[
        "wage",
        "wage_avg",
        "wage_avg_bra",
        "num_emp",
        "num_est",
        "num_emp_est",

        "val_usd",

        "enrolled",
        "students",
        "graduates",
        "entrants",
        "classes",
        "enrolled_classes",
        "age"
      ],
      "calculations":[
        "elsewhere",
        "required",
        "importance",
        "eci",
        "pci",
        "bra_diversity",
        "bra_diversity_eff",
        "cnae_diversity",
        "cnae_diversity_eff",
        "cbo_diversity",
        "cbo_diversity_eff",
        "hs_diversity",
        "hs_diversity_eff",
        "wld_diversity",
        "wld_diversity_eff",
        "rca",
        "rca_wld",
        "distance",
        "distance_wld",
        "opp_gain",
        "opp_gain_wld"
      ],
      "growth":[
        "wage_growth",
        "wage_growth_5",
        "num_emp_growth",
        "num_emp_growth_5",

        "val_usd_growth",
        "val_usd_growth_5",

        "enrolled_growth",
        "graduates_growth"
      ]

        }}

    for (g in app.tooltip.long) {
      var additionals = []
      app.tooltip.long[g].forEach(function(t){
        additionals.push("cp_bra_0_"+t)
        additionals.push("cp_bra_1_"+t)
      })
      app.tooltip.long[g] = app.tooltip.long[g].concat(additionals)
    }

    var averages = {
          "eci": "mean",
          "pci": "mean",
          "bra_diversity": "mean",
          "bra_diversity_eff": "mean",
          "cnae_diversity": "mean",
          "cnae_diversity_eff": "mean",
          "cbo_diversity": "mean",
          "cbo_diversity_eff": "mean",
          "hs_diversity": "mean",
          "hs_diversity_eff": "mean",
          "wld_diversity": "mean",
          "wld_diversity_eff": "mean",
          "rca": "mean",
          "rca_wld": "mean",
          "distance": "mean",
          "distance_wld": "mean",
          "opp_gain": "mean",
          "opp_gain_wld": "mean",
          "num_emp_est": "mean",
          "wage_avg": "mean",
          "wage_avg_bra": "mean",
          "wage_growth": "mean",
          "wage_growth_5": "mean",
          "num_emp_growth": "mean",
          "num_emp_growth_5": "mean",
          "val_usd_growth": "mean",
          "val_usd_growth_5": "mean",
          "importance": "mean"
        }

    var additionals = {}
    for (k in averages) {
      additionals["cp_bra_0_"+k] = averages[k]
      additionals["cp_bra_1_"+k] = averages[k]
    }

    averages = d3plus.object.merge(averages,additionals)

    var descs = {
      "distance": dataviva.format.text("distance_desc"),
      "distance_wld": dataviva.format.text("distance_desc"),
      "importance": dataviva.format.text("importance_desc"),
      "eci": dataviva.format.text("eci_desc"),
      "opp_gain": dataviva.format.text("opp_gain_desc"),
      "opp_gain_wld": dataviva.format.text("opp_gain_desc"),
      "pci": dataviva.format.text("pci_desc"),
      "rca": dataviva.format.text("rca_desc"),
      "rca_wld": dataviva.format.text("rca_desc"),
      "required": dataviva.format.text("required_desc"),
      "bra_diversity": dataviva.format.text("bra_diversity_desc"),
      "bra_diversity_eff": dataviva.format.text("bra_diversity_eff_desc"),
      "cnae_diversity": dataviva.format.text("cnae_diversity_desc"),
      "cnae_diversity_eff": dataviva.format.text("cnae_diversity_eff_desc"),
      "cbo_diversity": dataviva.format.text("cbo_diversity_desc"),
      "cbo_diversity_eff": dataviva.format.text("cbo_diversity_eff_desc"),
      "hs_diversity": dataviva.format.text("hs_diversity_desc"),
      "hs_diversity_eff": dataviva.format.text("hs_diversity_eff_desc"),
      "wld_diversity": dataviva.format.text("wld_diversity_desc"),
      "wld_diversity_eff": dataviva.format.text("wld_diversity_eff_desc")
    }

    // Define global D3plus app parameters
    app.viz = d3plus.viz()
      .container("#app")
      .aggs(averages)
      .time("year")
      .format({
        "number": dataviva.format.number,
        "text": dataviva.format.text
      })
      .text(["name","display_id"])
      .background("#ffffff")
      .tooltip({"html": app.html})
      .font({
        "family": app.font,
        "weight": "normal"
      })
      .total("required")
      .temp("elsewhere")
      .timeline(false)
      .x({
        "label": {"font": {"size": 18}},
        "ticks": {"font": {"size": 14}}
      })
      .y({
        "label": {"font": {"size": 18}},
        "ticks": {"font": {"size": 14}}
      })

    // app.viz = d3plus.viz()
    //   .name_array(["name","display_id"])
    //   .nesting_aggs(averages)
    //   .text_var("name")
    //   .year_var("year")
    //   .text_format(dataviva.format.text)
    //   .number_format(dataviva.format.number)
    //   .name_array(["name","display_id"])
    //   .background("#ffffff")
    //   .click_function(app.html)
    //   .font(app.font)
    //   .font_weight("normal")
    //   .total_var("required")
    //   .else_var("elsewhere")
    //   .info_style(app.loader_style)

    // Start building a new app
    app.start = function(new_url,allyears) {


      // Hide popover
      dataviva.popover.hide()
      app.allyears = allyears
      if (new_url) {



      	  info = new_url.split("/")
		  if('network' == info[0] || 'rings' == info[0]) {
		  	// RULE: Network/Rings forces the location MG when dataset is RAIS and Location is BRA
		  	if(info[1]=='rais' && info[2] == 'all') {
		  		info[2] = '4mg'
		  		new_url = info.join("/")
		  	}
		  }
		  if('occugrid' == info[0] || 'scatter' == info[0]) {
		  	// RULE: Occugrid/Scatter forces the location MG when Location is BRA
		  	if(info[2] == 'all') {
		  		info[2] = '4mg'
		  		new_url = info.join("/")

		  	}
		  }

        if (new_url != app.url || allyears) {
          app.url = new_url
          if (allyears) var t = "Downloading Additional Years"
          else var t = "Building App"
          loading.text(dataviva.format.text(t)).show(app.create)
        }
      }
      else {
        loading.text(dataviva.format.text("Building App")).show(app.create)
      }

    }

    app.create = function() {

      d3.select("#ui_bottom").selectAll("*").remove();
      d3.select("#app_controls").selectAll("*").remove();
      d3plus.tooltip.remove();

      d3.json("/apps/embed/"+app.url+"?lang="+dataviva.language)
        .header("X-Requested-With", "XMLHttpRequest")
        .get(function(error,data){

          if (error) {
          	console.log(error)
           // app.error(dataviva.format.text("Build Not Available"))
          }
          else {

            app.star(data.starred);
            app.recommendations = data.recommendations;

            if (app.build && app.build.app.type != data.current_build.app.type) {
              builder.app(data.current_build.app.type,true)
            }

            // Set public current build variable
            app.build = data.current_build
            last_depth = app.build.bra[0].id == "all" ? "bra_3" : "bra_9"
            leon("#app_select").color(app.build.app.color)
            builder.url()
            builder.outputs(data.all_builds)

            // Show/hide filters depending on build requirements
            var filters = ["bra_0","bra_1","cnae_0","cbo_0","hs_0","wld_0"]
            filters.forEach(function(filter){
              var type = filter.split("_")[0],
                  index = filter.split("_")[1]
              if (app.build[type] && app.build[type][index]) {
                d3.select("#"+filter).style("display","inline-block")
                builder.filter(app.build[type][index],filter,true)
              }
              else {
                d3.select("#"+filter).style("display","none")
              }
            })

            // Remove unused global_vars
            uis = []
            app.build.ui.forEach(function(ui){
              if (ui.type == "years") uis.push("year")
              else uis.push(ui.type)
            })
            for (v in app.vars) {
              if (uis.indexOf(v) < 0 && ["controls","builder"].indexOf(v) < 0) {
                delete app.vars[v];
              }
            }

            /***************************************/
            /* Data Calls and External Files Queue */
            /***************************************/

            var q = queue()

            if (app.data[app.build.data_url]) app.allyears = true

            if (!app.allyears && ["stacked", "line"].indexOf(app.build.app.type) < 0) {
              if (!app.vars.year || app.vars.year > max_year[app.build.data_url.split("/")[0]]) {
                app.vars.year = max_year[app.build.data_url.split("/")[0]]
              }
              app.build.data_url = app.build.data_url.replace("all",app.vars.year)
            }
            else {
              app.viz.time({"solo": []})
            }

            if (!app.data[app.build.data_url]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.data_url] = {}
                    app.data[app.build.data_url].raw = dataviva.cleanData(d, app.build.dataset, app.build.output)
                    if (d.eci) app.ecis[app.build.data_url] = d.eci
                    callback(error,d)
                  })
              },"/"+app.build.data_url)
            }

            if (app.build.dataset === "secex_export" && app.build.output === "all") {
              app.build.import_url = app.build.data_url.replace("secex_export/","secex_import/")
              if (!app.data[app.build.import_url]) {
                q.defer(function(u,callback){
                  d3.json(u)
                    .header("X-Requested-With", "XMLHttpRequest")
                    .get(function(error,d){
                      app.data[app.build.import_url] = {}
                      app.data[app.build.import_url].raw = dataviva.cleanData(d, app.build.dataset, app.build.output)
                      callback(error,d)
                    })
                },"/"+app.build.import_url)
              }
            }

            if (app.build.output != "all" && !app.attrs[app.build.output]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    var out = app.build.output
                    app.attrs[out] = {}
                    d.data.forEach(function(a){
                      a[out+"_id"] = a.id
                      a[out+"_display"] = dataviva.displayID(a.id,out)
                      a.icon = dataviva.icon(a.id,out)
                      app.attrs[app.build.output][a.id] = a
                      if (a["val_usd"]) delete a["val_usd"]
                      if (a["num_emp"]) delete a["num_emp"]
                    })

                    for (id in app.attrs[app.build.output]) {
                      var obj = app.attrs[app.build.output][id]
                      depths[out].forEach(function(d){
                        if (d <= obj.id.length && depths[out].indexOf(obj.id.length) >= 0) {
                          var id = obj[out+"_id"].slice(0, d)
                          obj[out+"_"+d] = {"name":app.attrs[app.build.output][id].name}
                          obj[out+"_"+d][out+"_id"] = id
                        }
                      })
                    }

                    callback(error,d)
                  })
              },"/attrs/"+app.build.output+"/"+"?lang="+dataviva.language)
            }

            if (["network","rings"].indexOf(app.build.app.type) >= 0
                && !app.networks[app.build.output]) {
              q.defer(function(u,callback){
                d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){

                    d.nodes.forEach(function(node){
                      if (app.build.output === "cnae") {
                        node[app.build.output+"_id"] = node.cnae_6;
                      }
                      else {
                        var id = node[app.build.output+"_id"];
                        node[app.build.output+"_"+id.length] = id;
                      }
                    })

                    d.edges.forEach(function(edge){
                      if (["hs"].indexOf(app.build.output) >= 0) {
                        edge.source = d.nodes[edge.source]
                        edge.target = d.nodes[edge.target]
                      }
                      else {
                        edge.source = d.nodes.filter(function(n){ return n[app.build.output+"_id"] == edge.source })[0]
                        edge.target = d.nodes.filter(function(n){ return n[app.build.output+"_id"] == edge.target })[0]
                      }
                    })

                    app.networks[app.build.output] = d
                    callback(error,d)
                  })
              },"/apps/networks/"+app.build.output+"/")
            }

			d3.selectAll("#settings #file").style("display","inline-block");
            if (app.build.app.type == "geo_map") {
			  d3.selectAll("#settings #file").style("display","none");
              if (app.build.bra[0].id == "all") {
                var json_id = "all"
              }
              else {
                var json_id = app.build.bra[0].id.substr(0,3)
              }

              if (!app.coords[json_id]) {
                q.defer(function(u,callback){
                  d3.json(u)
                    .header("X-Requested-With", "XMLHttpRequest")
                    .get(function(error,d){
                      app.coords[json_id] = d
                      callback(error,d)
                    })
                },"/apps/coords/"+json_id+"/")
              }

            }

            if (app.build.app.type == "occugrid") {

              var url = app.build.data_url.split("/")
              url[2] = "all"
              app.build.imp_url = url.join("/")

              if (!app.data[app.build.imp_url]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.imp_url] = {}
                    app.data[app.build.imp_url].raw = dataviva.cleanData(d, app.build.dataset, app.build.output)
                    callback(error,d)
                  })
                },"/"+app.build.imp_url)
              }

              var url = app.build.data_url.split("/")
              url[3] = "all"
              app.build.else_url = url.join("/")

              if (!app.data[app.build.else_url]) {
                q.defer(function(u,callback){
                  d3.json(u)
                  .header("X-Requested-With", "XMLHttpRequest")
                  .get(function(error,d){
                    app.data[app.build.else_url] = {}
                    app.data[app.build.else_url].raw = dataviva.cleanData(d, app.build.dataset, app.build.output)
                    callback(error,d)
                  })
                },"/"+app.build.else_url)
              }

            }

            q.awaitAll(app.finish)

          }
        });

    }

    app.error = function(error) {
      console.log("[dataviva] ERROR: "+error)
      dataviva.resize()
      app.viz.error(error).draw()
      loading.hide()
      // d3.select("#app").html("").datum([]).call(app.viz.error(error))
    }

    app.finish = function() {

      d3.select("#ui_bottom").selectAll("*").remove()
      d3.select("#app_controls").selectAll("*").remove()

      // Create Key
      if (app.build.app.type != "geo_map") {
        d3.select("#ui_bottom").append("div")
          .attr("id","key")
          .datum(app.attrs[app.build.output])
          .call(Key().type(app.build.output))
      }

      app.build.ui.forEach(function(ui){
        if (ui.type == "years") {

          // Determine current year
          if (!app.vars.year) {
            app.vars.year = ui.values[ui.values.length-1];
          }
          else if (ui.values.indexOf(app.vars.year) < 0) {
            var closest = null;
            ui.values.forEach(function(y){
              if (!closest || Math.abs(y-app.vars.year)
                  < Math.abs(closest-app.vars.year)) {
                closest = y;
              }
            })
            app.vars.year = closest;
          }

          var year = d3.select("#ui_bottom").append("div")
            .attr("id","year_slider")

          if (app.allyears) {

            leon({
              "type": "range",
              "event": app.update,
              "id": "year",
              "data": {"min": ui.values[0], "max": ui.values[ui.values.length-1], "step": 1},
              "default": app.vars.year,
              "parent": document.getElementById("year_slider"),
              "label": dataviva.format.text("year")
            }).color(app.build.app.color)

          }
          else {
            var b = year.append("input")
              .attr("type","button")
              .attr("id","allyears")

            var label = year.append("label")
              .attr("for","allyears")

            label.append("i")
              .attr("class","fa fa-play")
              .attr("style","color:"+app.build.app.color+";")

            label.append("div")
              .attr("style","display:inline-block;margin-left:5px;")
              .html(dataviva.format.text("Show All Years"))

            b.node().onclick = function(){
              app.start(app.url,true)
            }

            leon("#allyears").color(app.build.app.color)
          }

        }
        else {

          // Custom Titles
          if (ui.type == "size") {
            if (app.build.app.type == "geo_map") var title = "color"
            else var title = "sizing"
          }
          else if (ui.type == "spotlight" && app.build.app.type == "scatter") {
            var title = "spotlight_scatter"
          }
          else var title = ui.type

          // Set Global Vars
          if (ui.type == "size") {
            if (app.build.app.type == "occugrid") var default_value = "required"
            else if (ui.values.indexOf("val_usd") >= 0) var default_value = "val_usd"
            else if (ui.values.indexOf("num_emp") >= 0) var default_value = "num_emp"
            else var default_value = ui.values[0]
          }
          else if (ui.type == "depth") {
            var bra_id = app.build.bra[0].id
            if (app.build.output == "bra" && bra_id != "all") {
              // if (bra_id.indexOf("4mg") == 0) ui.values[1] = "bra_7"
              if (bra_id.length >= 2) ui.values.splice(0,1)
              if (bra_id.length >= 4) ui.values.splice(0,1)
            }
            if (app.build.output == "bra" && app.build.bra[0].id == "all") {
              var default_value = ui.values[0]
            }
            else if (app.build.app.type == "tree_map") {
              var default_value = ui.values[ui.values.length-1]
            }
            else {
              var default_value = ui.values[0]
            }
          }
          else if (ui.type == "order" && app.build.app.type == "stacked") {
            var default_value = "color"
          }
          else if (ui.type == "spotlight" && app.build.app.type == "scatter") {
            var default_value = ui.values[1]
          }
          else if (ui.type == "rca_scope" && app.build.bra[0].id == "all" && app.build.output == "hs") {
            var default_value = "wld_rca"
          }
          else {
            var default_value = ui.values[0]
          }

    		  if(ui.type == "rca_scope"){
      			var default_value = "wld_rca"
    		  }
    		  if(ui.type == "spotlight"){
      			var default_value = "true"
    		  }

          if((last_app && last_app != app.build.app.type) || (!app.vars[ui.type] || ui.values.indexOf(app.vars[ui.type]) < 0)) {
            app.vars[ui.type] = default_value
          }

          if (ui.values.length > 1 && app.vars.builder !== "false" && (app.build.app.type != "network" || app.build.bra[0].id != "all" || (ui.type != "spotlight" && ui.type != "rca_scope") || (ui.type == "spotlight" && app.build.output == "hs") || (ui.type != "color" && app.build.app.type != "stacked"))) {

            var ui_data = []
            ui.values.forEach(function(v){
              if(!(v == "bra_rca" &&  app.build.bra[0].id == "all" &&  app.build.app.type == "network")) {
                ui_data.push({
                  "text": dataviva.format.text(v),
                  "value": v
                })
              }
            })

            var form_type = ui_data.length > 3 ? "drop" : "toggle";
            if (["color"].indexOf(title) >= 0) {
              form_type = "drop";
            }
            else if (["sizing"].indexOf(title) >= 0) {
              form_type = "toggle";
            }

      			var ui_div = d3.select("#app_controls").append("div")
        			.attr("class","ui_group alt_tooltip")
        			.attr("alt",dataviva.format.text(title+"_desc_"+app.build.app.type))
        			.on(d3plus.client.pointer.over,function(){
        			  if (form_type === "drop") dataviva.ui.tooltip("alt_tooltip",this,"center right")
        			  else dataviva.ui.tooltip("alt_tooltip",this)
        			})
        			.on(d3plus.client.pointer.out,function(){
        			  dataviva.ui.tooltip("alt_tooltip",false)
        			})

            if (title === "color") title = "color_toggle";

            d3plus.form()
              .container({
                "id": "ui_" + ui.type,
                "value": ui_div
              })
              .type(form_type)
              .data({
                "sort": false,
                "value": ui_data
              })
              .text("text")
              .id("value")
              .focus(app.vars[ui.type], app.update)
              .title(dataviva.format.text(title))
              .ui({
                // "color": app.build.app.color
                "margin": 0
              })
              .draw()

          }

        }

      })

      // Format Data if it hasn't already been formatted
      if (!app.data[app.build.data_url][format[app.build.app.type]]) {
        app.format_data()
      }

      var nesting = []
      if (app.build.output === "all") {
        nesting.push("id")
      }
      else {
        depths[app.build.output].forEach(function(d){
          nesting.push(app.build.output+"_"+d)
        })
      }

      app.solos = []
      app.filters = []
      builder.url()

      var color_var = app.vars.color ? app.vars.color : "color"

      app.title_update()

      /************************/
      /* Gloabl App Variables */
      /************************/
      if (app.build.output == "bra" || (app.build.output == "wld" && app.vars.depth == "wld_5")) var style = "default"
      else var style = "knockout"

      if (app.build.output == "bra") {
        app.tooltip["short"][""] = ["id_ibge"]
        app.tooltip["long"][""] = ["id_ibge"]
        app.tooltip["short"]["basics"] = [app.vars.size]
      }
      else {
        app.tooltip["short"][""] = [app.build.output+"_display"]
        app.tooltip["long"][""] = [app.build.output+"_display"]
        if (app.build.app.type == "occugrid") {
          app.tooltip["short"]["calculations"] = ["elsewhere","required"]
        }
        else {
          app.tooltip["short"]["basics"] = [app.vars.size]
          app.tooltip["short"]["calculations"] = []
        }
      }

      if (app.build.bra[0].id == "all" && app.build.app.type == "network") {
        app.vars.spotlight = false
      }
      else if (app.vars.spotlight === "true") {
        app.vars.spotlight = true
      }
      else if (app.vars.spotlight === "false") {
        app.vars.spotlight = false
      }

      if ("grouping" in app.vars) {
        if (app.vars.grouping === "true") {
          app.vars.grouping = true
        }
        else if (app.vars.grouping === "false") {
          app.vars.grouping = false
        }
      }

      app.viz
        .type(app.build.app.d3plus)
        .title({
          "sub": app.sub_title(),
          "total": app.total(),
          "value": app.build.title
        })
        .color(color_var)
        .attrs(app.attrs[app.build.output])
        .active({"spotlight": app.vars.spotlight})
        .id(nesting)
        .depth(nesting.indexOf(app.vars.depth))
        .id({"grouping": app.vars.grouping})
        .order({
          "sort": app.vars.sort,
          "value": app.vars.order
        })
        // .layout(app.vars.layout)
        .size(app.vars.size)
        .focus(false)
        .error(false)
        .id({
          "solo": app.solos,
          "mute": app.filters
        })
        .icon({
          "style": style,
          "value": "icon"
        })
        .y(false)
        .tooltip(app.tooltip)
        .zoom(true)

      if (app.vars.year) app.viz.time({"solo": [app.vars.year]})
      else app.viz.time({"solo": false})

      // app.viz.type(app.build.app.d3plus)
      //   .title(app.build.title)
      //   .color_var(color_var)
      //   .attrs(app.attrs[app.build.output])
      //   .spotlight(app.vars.spotlight)
      //   .nesting(nesting)
      //   .depth(app.vars.depth)
      //   .sort(app.vars.sort)
      //   .grouping(app.vars.grouping)
      //   .order(app.vars.order)
      //   .layout(app.vars.layout)
      //   .value_var(app.vars.size)
      //   .year(app.vars.year)
      //   .total_bar(app.total())
      //   .highlight(null)
      //   .id_var(app.build.output+"_id")
      //   .error(false)
      //   .solo(app.solos)
      //   .filter(app.filters)
      //   .sub_title(app.sub_title())
      //   .icon_style(style)
      //   .yaxis_val(null)
      //   .tooltip_info(app.tooltip)

      if (same_origin &&
          (window.parent.location.href.indexOf("dataviva.info") >= 0 ||
          window.parent.location.href.indexOf("localhost") >= 0 ||
          window.parent.location.href.indexOf("dataviva.mg.gov.br") >= 0)) {
        app.viz.footer(footer[app.build.dataset])
      }
      else {
        app.viz.footer(app.embed_footer)
      }

      app.viz.labels({"align": "center", "valign": "middle"})

      /*******************************/
      /* Tree Map Specific Variables */
      /*******************************/
      if (app.build.app.type === "tree_map") {

        app.viz
          .labels({"align": "left", "valign": "top"})
          .active(false)
          .temp(false)
          .total(false)
          .size({"threshold": false})
          .zoom(false)
          .id({"grouping": true})
          .shape("square")

      }

      /******************************/
      /* Network Specific Variables */
      /******************************/
      else if (app.build.app.type == "network") {
        if ((app.build.bra[0].id === "all" && app.build.output !== "hs") || app.build.output === "cbo") {
          app.viz.active(function(d){return true;})
        }
        else if (app.build.output == "hs") {
          if (app.vars.rca_scope == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
        }
        else if (app.build.output == "cnae") {
          app.viz.active(function(d){
            return d.rca >= 1;
          })
        }

        app.viz
          .edges(app.networks[app.build.output].edges)
          .nodes(app.networks[app.build.output].nodes)
          .depth(app.viz.id(Object).nesting.length - 1)
          .size({"scale": {"min": 3}})
          .shape("circle")
      }

      /****************************/
      /* Rings Specific Variables */
      /****************************/
      else if (app.build.app.type == "rings") {
        if (app.build.output == "hs") {
          if (app.vars.rca_scope == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
        }
        else if (app.build.output == "cnae") {
          app.viz.active(function(d){
            return d.rca >= 1;
          })
        }
        else {
          app.viz.active(function(d){return true;})
        }
        app.viz
          .edges(app.networks[app.build.output].edges)
          .nodes(app.networks[app.build.output].nodes)
          .focus(app.build[app.build.output][0].id)
          .depth(app.viz.id(Object).nesting.length - 1)
          .shape("circle")
      }

      /******************************/
      /* Geo Map Specific Variables */
      /******************************/
      else if (app.build.app.type == "geo_map") {
        if (app.build.bra[0].id == "all") {
          var coords = app.coords.all
        }
        else if (app.build.bra[0].id.indexOf("plr") >= 0) {
          var coords = {"type": "Topology", "objects": {"geojson": {"geometries": [], "type": "GeometryCollection"}}}
          coords.transform = app.coords[app.build.bra[0].id.substr(0,3)].transform
          coords.arcs = app.coords[app.build.bra[0].id.substr(0,3)].arcs
          coords.objects.geojson.geometries = app.coords[app.build.bra[0].id.substr(0,3)].objects.geojson.geometries.filter(function(g){
            return app.build.bra[0].pr_ids.indexOf(g.bra_id) >= 0
          })
        }
        else if (app.build.bra[0].id.length == 5) {
          var coords = {"type": "Topology", "objects": {"geojson": {"geometries": [], "type": "GeometryCollection"}}}
          coords.transform = app.coords[app.build.bra[0].id.substr(0,3)].transform
          coords.arcs = app.coords[app.build.bra[0].id.substr(0,3)].arcs
          coords.objects.geojson.geometries = app.coords[app.build.bra[0].id.substr(0,3)].objects.geojson.geometries.filter(function(g){
            return g.bra_id.substr(0,5) == app.build.bra[0].id
          })
        }
        else if (app.build.bra[0].distance > 0) {
          var coords = {"type": "Topology", "objects": {"geojson": {"geometries": [], "type": "GeometryCollection"}}}
          coords.transform = app.coords[app.build.bra[0].id.substr(0,3)].transform
          coords.arcs = app.coords[app.build.bra[0].id.substr(0,3)].arcs
          coords.objects.geojson.geometries = app.coords[app.build.bra[0].id.substr(0,3)].objects.geojson.geometries.filter(function(g){
            return app.build.bra[0].neighbor_ids.indexOf(g.bra_id) >= 0
          })
        }
        else {
          var coords = app.coords[app.build.bra[0].id.substr(0,3)]
        }

        app.viz
          .coords(coords)
          .focus(false)
          .active(false)
          .temp(false)
          .total(false)
          .depth(app.viz.id(Object).nesting.length - 1)
          .shape("coordinates")

      }

      /******************************/
      /* Bubbles Specific Variables */
      /******************************/
      else if (app.build.app.type == "occugrid") {

        if (app.vars.order === "name") {
          app.viz.order({"sort": "asc"})
        }
        else {
          app.viz.order({"sort": "desc"})
        }

        app.viz
          .active("num_emp_est")
          .shape("donut")
          .size({"scale": {"min": 10}})
          .depth(app.viz.id(Object).nesting.length - 1)
      }

      /******************************/
      /* Stacked Specific Variables */
      /******************************/
      else if (app.build.app.type == "stacked") {
        app.viz
          .x({
            "scale": "linear",
            "value": "year"
          })
          .y({"scale": "linear"})
          .active(false)
          .temp(false)
          .total(false)
          .size({"threshold": true})
          .id({"grouping": true})
          .shape("area")
      }

      /******************************/
      /* Scatter Specific Variables */
      /******************************/
      else if (app.build.app.type == "scatter") {
        if (app.build.output == "hs") {
          if (app.vars.rca_scope == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
        }
        else {
          app.viz.active(function(d){
            return d.rca >= 1;
          })
        }
        if (app.build.output == "hs" && app.vars.rca_scope == "wld_rca") {
          var yv = app.vars.y + "_wld",
              xv = app.vars.x + "_wld"
        }
        else {
          var yv = app.vars.y,
              xv = app.vars.x
        }
        if (app.vars.y.indexOf("pci") >= 0) yv = app.vars.y

        var yval = null
        if (app.build.output == "hs" && app.ecis[app.build.data_url] && yv == "pci") {
          var yval = {"eci": app.ecis[app.build.data_url][app.vars.year]}
        }
        app.viz
          .x({
            "scale": "linear",
            "value": xv
          })
          .y({
            "lines": [yval],
            "scale": "linear",
            "value": yv
          })
          .axes({"mirror": false})
          .active({"spotlight": app.vars.spotlight})
          .size({"scale": {"min": 3}})
          .id({"grouping": true})
          .shape("circle")
      }

      /******************************/
      /* Compare Specific Variables */
      /******************************/
      else if (app.build.app.type == "compare") {

        app.viz
          .x({
            "scale": app.vars.scale,
            "value": "cp_bra_1_"+app.vars.axes
          })
          .y({
            "scale": app.vars.scale,
            "value": "cp_bra_0_"+app.vars.axes
          })
          .axes({"mirror": true})
          .active({"spotlight": false})
          .active(false)
          .temp(false)
          .total(false)
          .size({"scale": {"min": 3}})
          .id({"grouping": true})
          .shape("circle")

      }

      /******************************/
      /* Line Specific Variables */
      /******************************/
      else if (app.build.app.type === "line") {

        app.viz
        .x("year")
        .y({
          "scale": app.vars.scale,
          "value": app.vars.y
        })
        .axes({"mirror": false})
        .active({"spotlight": false})
        .active(false)
        .temp(false)
        .total(false)
        .id({"grouping": true})
        .shape("line")

      }

      last_app = app.build.app.type

      if(app.build.app.type == "scatter" && app.build.bra[0].id == "all") {
        app.viz.data(false)
      }
      else {
        app.viz.data(app.data[app.build.data_url][format[app.build.app.type]])
        // d3.select("#app")
        //   .html("")
        //   .datum(app.data[app.build.data_url][format[app.build.app.type]])
      }

      app.viz.legend(app.vars.color !== undefined && app.vars.color !== "color")

      if (app.build.app.type != "rings") builder.key()
      dataviva.resize()
      loading.hide()
      app.first_load = true

    }

    app.sub_title = function() {
      var elems = app.build.bra,
          same = elems.length == 1 || (elems.length == 2 && elems[0].id.length == elems[0].id.length),
          mix = elems.length == 2 && (elems[0].id == "all" || elems[1].id == "all") && (elems[0].id.length == 2 || elems[1].id.length == 2)
          depth = elems[0].id.length,
          secex = app.build.dataset.indexOf("secex") === 0,
          munics = app.build.output == "bra",
          text = false;

      if (secex && same && !mix) {
        if ((munics && depth >= 3) || (app.build.output === "all" && depth > 3)) {
          text = dataviva.format.text("secex_9")
        }
        else {
          text = dataviva.format.text("secex_3")
        }
      }
      descs["val_usd"] = text
      app.viz.descs(descs)
      return text
    }

    app.update = function(value, type) {


      if (typeof type !== "string") type = type.container(Object).id.slice(3);

      if (type == "solo" || type == "filter") {

        app[type+"s"] = value

        var ids = []
        if (app.solos.length >= 1 && app.solos.length <= app.categories.length/2) {
          var prefix = dataviva.format.text("showing")+" "
          ids = app.solos
        }
        else if (app.solos.length > app.categories.length/2) {
          var prefix = dataviva.format.text("excluding")+" "
          cats.forEach(function(c){
            if (app.solos.indexOf(c) < 0) ids.push(c)
          })
        }
        else if (app.filters.length >= 1 && app.filters.length <= app.categories.length/2) {
          var prefix = dataviva.format.text("excluding")+" "
          ids = app.filters
        }
        else if (app.filters.length > app.categories.length/2) {
          var prefix = dataviva.format.text("showing")+" "
          cats.forEach(function(c){
            if (app.filters.indexOf(c) < 0) ids.push(c)
          })
        }

        var names = []
        ids.forEach(function(id){
          names.push(app.attrs[app.build.output][id].name)
        })

        if (names.length > 0) {
          var text = prefix
          names.forEach(function(n,i){
            if (i != 0 && names.length != 2) text += ", "
            if (i == names.length-1 && i != 0) text += " "+dataviva.format.text("and")+" "
            text += n
          })
          var sub = text
        }
        else {
          var sub = false
        }

        var method = type === "filter" ? "mute" : "solo";
        var filterObj = {}
        if (app[type+"s"].length) {
          filterObj[method] = app[type+"s"]
        }
        else {
          filterObj[method] = false
        }

        app.viz.id(filterObj).title({"sub": sub}).draw()
        // d3.select("#app").call(app.viz[type](app[type+"s"]).sub_title(sub))

      }
      else {

        var old_value = app.vars[type]
        app.vars[type] = value
        builder.url()

        if (type == "year" && app.build.app.type != "rings") {
          builder.key()
          dataviva.resize(true)
        }

        if (!app.solos.length && !app.filters.length) {
          app.viz.title({"sub": app.sub_title()})
        }

        if (type == "depth" || type == "year") {
          app.title_update()
          app.viz.title(app.build.title)
        }

        if (type == "depth" && app.build.output == "wld") {
          if (app.vars.depth == "wld_5") app.viz.icon({"style": "default"})
          else app.viz.icon({"style": "knockout"})
        }

        if (type == "year" && app.build.app.type == "scatter") {
          var yval = null
          if (app.build.output == "hs" && app.ecis[app.build.data_url] && app.vars.y == "pci") {
            var yval = {"eci": app.ecis[app.build.data_url][app.vars.year]}
          }
          app.viz.y({"lines": [yval]})
        }

        if (type == "axes") {
          app.viz.x("cp_bra_1_"+value).y("cp_bra_0_"+value)
        }
        else if (type == "scale") {
          app.viz.x({"scale": value}).y({"scale": value})
        }
        else if (type == "rca_scope") {
          if (value == "wld_rca") {
            app.viz.active(function(d){
              return d.rca_wld >= 1;
            })
          }
          else {
            app.viz.active(function(d){
              return d.rca >= 1;
            })
          }
          if (app.build.app.type == "scatter") {
            if (app.build.output == "hs" && value == "wld_rca") {
              var yv = app.vars.y + "_wld",
                  xv = app.vars.x + "_wld"
            }
            else {
              var yv = app.vars.y,
                  xv = app.vars.x
            }
            if (app.vars.y.indexOf("pci") >= 0) yv = app.vars.y
            app.viz.x(xv).y(yv)
          }
        }
        else if (type == "x") {
          if (app.vars.rca_scope == "wld_rca") {
            var xv = app.vars.x + "_wld"
          }
          else {
            var xv = app.vars.x
          }
          app.viz.x(xv).title({"total": app.total()})
        }
        else if (type == "y") {
          if (app.vars.rca_scope == "wld_rca" && app.vars.y.indexOf("pci") < 0) {
            var yv = app.vars.y + "_wld"
          }
          else {
            var yv = app.vars.y
          }

          var yval = null
          if (app.build.output == "hs" && app.ecis[app.build.data_url] && app.vars.y == "pci") {
            var yval = {"eci": app.ecis[app.build.data_url][app.vars.year]}
          }

          app.viz.y({"lines": [yval], "value": yv}).title({"total": app.total()})
        }
        else if (type == "size") {
          if (app.build.app.type !== "occugrid") {
            app.tooltip["short"]["basics"] = [app.vars.size]
          }
          if (app.viz.order() === app.viz.size()) {
            app.viz.order(value)
          }
          app.viz[type](value).title({"total": app.total()}).tooltip(app.tooltip)
        }
        else if (type === "depth") {
          app.viz[type](app.viz.id(Object).nesting.indexOf(value))
        }
        else if (type === "year") {
          app.viz.time({"solo": [parseFloat(value)]})
        }
        else if (type === "layout") {
          var yscale = value === "value" ? "linear" : "share";
          app.viz.y({"scale": yscale})
        }
        else if (type === "sort") {
          app.viz.order({"sort": value})
        }
        else if (type === "order" && value === "value") {
          app.viz.order(app.viz.size())
        }
        else if (type === "spotlight") {
          if (value === "true") {
            value = true;
          }
          else {
            value = false;
          }
          app.viz.active({"spotlight": value})
        }
        else if (type === "grouping") {
          if (value === "true") {
            value = true;
          }
          else {
            value = false;
          }
          app.viz.id({"grouping": value})
        }
        else {
          app.viz[type](value)
        }

        if (type === "color") {
          app.viz.legend(value !== "color")
        }

        if (type === "order" && app.build.app.type === "occugrid") {
          if (value === "name") {
            app.viz.order({"sort": "asc"})
          }
          else {
            app.viz.order({"sort": "desc"})
          }
        }

        app.viz.draw()
        // d3.select("#app").call(app.viz)
      }
    }

    app.format_data = function() {

      var data_obj = [],
          data = app.data[app.build.data_url],
          out = app.build.output,
          attr = app.attrs[out],
          outdepths = dataviva.depths(app.build.output);

      if ("occugrid" == format[app.build.app.type]) {

        var jobs = app.data[app.build.imp_url].raw.sort(function(a,b){
          return b.importance - a.importance
        })

        var year_jobs = {}
        jobs.forEach(function(j){
          if (j.importance >= 0.2) {
            if (!year_jobs[j.year]) year_jobs[j.year] = [j]
            else year_jobs[j.year].push(j)
          }
        })

        for (year in year_jobs) {
          year_jobs[year].forEach(function(job){
            var d = data.raw.filter(function(x){
              return x.cbo_id == job.cbo_id && x.year == year
            })[0]
            if (d && d.required) {
              d.importance = job.importance
              d.category = attr[d[out+"_id"].slice(0,depths[out][0])].name
              d.none = 1

              d.required = Math.ceil(d.required)

              if (!d.wage) d.wage = 0
              if (!d.num_emp) d.num_emp = 0
              if (!d.num_est) d.num_est = 0
              if (!d.wage_avg) d.wage_avg = 0

              d.num_emp_est = Math.ceil(d.num_emp/d.num_est);

              d.wage_avg_bra = job.wage_avg

              var else_data = app.data[app.build.else_url].raw.filter(function(e){
                return e.cbo_id == d.cbo_id && e.year == d.year
              })[0]

              d.active = d.num_emp/d.required >= 1 ? true : false

              if (!else_data) d.elsewhere = 0
              else d.elsewhere = else_data.num_emp-d.num_emp

              d[out+"_display"] = dataviva.displayID(d[out+"_id"],out)
              // d.icon = dataviva.icon(d[out+"_id"],out)

              get_keys(d)

              data_obj.push(d)

            }
          })
        }

      }
      else if ("compare" == format[app.build.app.type]) {

        d3.nest()
          .key(function(d){return d.year})
          .key(function(d){return d[out+"_id"]})
          .rollup(function(leaves){
            if (leaves.length == 2 && leaves[0][app.vars.axes] && leaves[1][app.vars.axes]) {
              var d = {}
              d.year = leaves[0].year
              d[out+"_id"] = leaves[0][out+"_id"]
              d[out+"_display"] = dataviva.displayID(d[out+"_id"],out)

              outdepths.forEach(function(dd){
                d[out+"_"+dd] = leaves[0][out+"_"+dd]
              })

              leaves.forEach(function(leaf){
                for (key in leaf) {
                  if (key != "bra_id" && key != out+"_id") {
                    if (typeof leaf[key] === "number" && key != "year") {
                      if (!d[key]) d[key] = 0
                      d[key] += leaf[key]
                    }
                    if (leaf.bra_id == app.build.bra[0].id) var k = "cp_bra_0_"+key
                    else if (leaf.bra_id == app.build.bra[1].id) var k = "cp_bra_1_"+key
                    d[k] = leaf[key]
                  }
                }
              })

              get_keys(d)

              data_obj.push(d)

            }
          })
          .entries(data.raw)
      }
      else if (app.build.dataset === "secex_export" && app.build.output === "all") {

        data.raw.forEach(function(d){

          var obj = d3plus.util.copy(d);
          obj.name = "secex_export";
          obj.id = "export";
          obj.color = "#0b1097";
          get_keys(obj);
          data_obj.push(obj);

          var imp = app.data[app.build.import_url].raw.filter(function(i){
            return i.year === d.year;
          })

          if (imp.length) {
            imp = d3plus.util.copy(imp[0]);
            imp.name = "secex_import";
            imp.id = "import";
            imp.color = "#af1f24";
            get_keys(imp);
            data_obj.push(imp);
          }

        })

      }
      else {

        data.raw.forEach(function(d){

          var obj = d

          if (out !== "all") obj[out+"_display"] = dataviva.displayID(obj[out+"_id"],out)

          obj.bra_rca = obj.rca >=1 ? true : false;
          obj.wld_rca = obj.rca_wld >=1 ? true : false;

          get_keys(obj)

          data_obj.push(obj)

        })

      }

      data[format[app.build.app.type]] = data_obj;

      function get_keys(d) {
        if (!data.categories) data.categories = {}
        if (!data.categories[d.year]) data.categories[d.year] = []
        if (!data.categories.all) data.categories.all = []
        if (out !== "all") var parent = d[out+"_id"].slice(0,depths[out][0])
        if (data.categories[d.year].indexOf(parent) < 0) data.categories[d.year].push(parent);
        if (data.categories.all.indexOf(parent) < 0) data.categories.all.push(parent);
      }

    }

    app.total = function() {

      var exclusions = [
            "eci",
            "pci",
            "unique_cnae",
            "unique_cbo",
            "none",
            "importance",
            "wage_avg",
            "wage_avg_bra",
            "required_wage_avg",
            undefined
          ],
          val = app.vars.size

      if (exclusions.indexOf(val) >= 0) return false;

      var prefix = dataviva.format.text(val)
      if (app.build.app.type == "scatter") {
        var prefix = dataviva.format.text(app.build.output+"_plural")
        prefix += " "+dataviva.format.text("with")
        prefix += " "+dataviva.format.text(app.vars.x)
        if (app.vars.x != app.vars.y) {
          prefix += " "+dataviva.format.text("and")
          prefix += " "+dataviva.format.text(app.vars.y)
        }
        if (app.build.output != "hs") {
          prefix += " ("+dataviva.format.text(val)+")"
        }
      }
      prefix += ": "

      return {"prefix": prefix, "suffix": ""};

    }

    app.star = function(status) {

      function update_star(s) {
        d3.select("#starred > i")
          .attr("id","status_"+s)
          .attr("class",function() {
            return s == 1 ? "fa fa-star" : "fa fa-star-o";
          })
      }

      if ( status !== undefined ) {
        update_star(status)
      }
      else if ( "{{g.user.is_authenticated()}}" === "False" ) {
        login()
      }
      else {

        var id = d3.select("#starred > i").attr("id")
          , current_status = parseInt(id.split("_")[1],10)

        d3.select("#starred > i")
          .attr("class",function(){
            return this.className + " fa fa-spin"
          })

        var url = window.location.pathname.replace("embed","star")

        d3.json(url)
          .header("Content-type","application/x-www-form-urlencoded")
          .post("title="+app.build.title, function(error,data) {
            if (data.success) {
              update_star(data.success)
            }
            else {
              update_star(current_status)
            }
          })

      }

    }

    app.download = function(obj) {

      var type = obj.id,
          title = app.build.app.name+"-"+app.build.title,
          columns = [],
          formattedColumns = []

      for (cat in app.tooltip.long) {
        app.tooltip.long[cat].forEach(function(k){
          columns.push(k)
        })
      }

      title = title.removeAccents().split(" ").join("_")

      var form = document.getElementById("svgform");

      if(type == "csv"){
        form['data'].value = d3.tsv.formatRows(app.viz.csv(columns));
        // form['data'].value = d3.tsv.formatRows(app.viz.csv_columns(columns).csv_data());
      }
      else {
        if (app.build.app.type == "geo_map") var svg = d3.select("div#map svg")
        else var svg = d3.select("#app > svg")
        // Add necessary name space junk and get raw node
        svg.attr("version", 1.1)
          .attr("xmlns", "http://www.w3.org/2000/svg")
          .node()
        // Extract the data as SVG text string
        var svg_xml = (new XMLSerializer).serializeToString(svg.node());
        form['data'].value = svg_xml;
      }
      // Submit the <FORM> to the server.
      // The result will be an attachment file to download.
      form['output_format'].value = type;
      form['title'].value = title;
      form['downloadToken'].value = new Date().getTime();
      csrf_token = document.getElementById("csrf_token").value;
	  form['data'].value = form['data'].value.replace(/&/g, "%26")
	  progress = 0
	  d3.xhr("/apps/download/")
	  .header("Content-Type", "application/x-www-form-urlencoded")
        .post("output_format="+type+"&title="+ title+"&downloadToken="+ new Date().getTime() +"&data="+ form['data'].value +"&csrf_token="+ csrf_token, function(e, data){
		  urlFile = data.response
		})
		.on("progress", function() {

	      var i = d3.interpolate(progress, d3.event.loaded / d3.event.position);
	      var progress_txt = d3.select("#popover").select(".text").text()

	      d3.select("#popover").select(".text").text(progress_txt + " (0%)")

	      d3.transition().tween("progress", function() {
	        return function(t) {
	          progress = i(t);
	          progress_display = " ("+parseInt(progress*100) + "%)"
	          d3.select("#popover").select(".text").text(progress_txt + progress_display)
	          if(progress==1) {
	          	setTimeout(function() { top.location.href = urlFile; downloadDone(); } , 1000);
	          }
	        };
	      });
	    })


    }

    app.title_update = function() {

      if (app.build.output == "bra") {
        var words = app.build.title.split(" ")
        if (app.vars.depth) {
          var new_depth = dataviva.format.text(app.vars.depth)
          var old_depth = dataviva.format.text(last_depth)
          if (words[words.length-2] == old_depth) words[words.length-2] = new_depth
          else if (words[words.length-1] == old_depth) words[words.length-1] = new_depth
          else {
            var new_depth = dataviva.format.text(app.vars.depth+"_plural")
            var old_depth = dataviva.format.text(last_depth+"_plural")
            if (words[0] == old_depth) words[0] = new_depth
          }
          app.build.title = words.join(" ")
          last_depth = app.vars.depth
        }
        else if (app.build.app.type == "geo_map" && app.build.bra[0].id == "all") {
          var old_word = dataviva.format.text("bra_8_plural")
          var new_word = dataviva.format.text("bra_2_plural")
          app.build.title = app.build.title.replace(old_word,new_word)
        }
      }
      if (app.vars.year && app.build.app.type != "stacked") {
        if (app.build.title.indexOf("(") < 0) {
          app.build.title += " ("+app.vars.year+")"
        }
        else {
          app.build.title = app.build.title.replace(/\(.*?\)/, "("+app.vars.year+")")
        }
      }
      if (same_origin && window.frameElement) {
        var message = {"id": window.frameElement.id, "title": app.build.title, "app": app.build.app.type}
        if (same_origin && window.parent.update_titles) window.parent.update_titles(message)
      }
    }

    /*********************/
    /* Builder Functions */
    /*********************/

    var builder = {}
    builder.outputs = function(builds) {

      app.all_builds = builds

      app.all_builds.forEach(function(build){
        d3.select("#output_"+build.app.type).remove()
      })

      app.all_builds.forEach(function(build){

        if (d3.select("#output_"+build.app.type).empty()) {
          dataviva.popover.create({
            "id": "output_"+build.app.type,
            "width": 600,
            "height": "80%",
            "color": build.app.color
          })
          d3.select("#output_"+build.app.type)
            .append("div").attr("class","scrolling_content")
        }

        var box = d3.select("#output_"+build.app.type).select("div.scrolling_content")

        if (box.select("."+build.dataset).empty()) {
          box.append("div")
            .attr("class",build.dataset+" output_list")
            .append("div")
              .attr("class","title")
              .text(dataviva.format.text(build.dataset))
        }

        if (build.url == app.build.url) var c = "decision"
        else var c = "help"

        box.select("."+build.dataset).append("div")
          .attr("id",build.url)
          .attr("class","output "+c+" icon "+build.app.type)
          .html(build.title)
          .on(d3plus.client.pointer.click,function(){
            app.start(this.id)
          })

      })

      if (d3.selectAll("#output_"+app.build.app.type+" .output")[0].length == 1) {
        d3.select("#output").style("display","none")
      }
      else {
        d3.select("#output").style("display","inline-block")
      }

    }

    builder.filter = function(obj,id,static) {

      var type = id.split("_")[0],
          index = id.split("_")[1],
          old_obj = app.build[type][index]
          new_name = obj.name ? obj.name : obj["name_"+dataviva.language]

      if (type == "bra") {
        var url_index = 2
      }
      else if (["hs","cnae"].indexOf(type) >= 0) {
        var url_index = 3
      }
      else {
        var url_index = 4
      }

      app.build[type][index] = obj

      var url = app.url.split("/")
      var ids = url[url_index].split("_")
      if (obj.distance && obj.distance > 0) {
        ids[index] = obj.id+"."+obj.distance
      }
      else {
        ids[index] = obj.id
      }
      url[url_index] = ids.join("_")
      url = url.join("/")

      var button = d3.select("#"+id)

      if (type == "bra" && !obj.distance) obj.distance = 0

      if (!obj.icon) obj.icon = dataviva.icon(obj.id,type)

      button.select(".icon")
       .style("background-image","url("+obj.icon+")")

      if (["wld","bra"].indexOf(type) < 0 || (type == "wld" && obj.id.length != 5)) {
        button.select(".icon").style("background-color",obj.color)
      }
      else {
        button.select(".icon").style("background-color","rgba(0,0,0,0)")
      }

      if (obj.distance > 0 && type == "bra") new_name += " "+obj.distance+"km"

      button.select(".list_text").text(new_name)

      if (!static) {
        app.start(url)
      }

    }

    builder.app = function(app_name,static) {

      document.getElementById("app_select").value = app_name

      var options = d3.select("#output_"+app_name).selectAll(".output")

      if (options[0].length > 1) {
        d3.select("#output").style("display","inline-block")
      }
      else {
        d3.select("#output").style("display","none")
      }

      if (!static) {

        var match = null, backup = null, backup2 = null

        options
          .each(function(d){
            var a = app.url.split("/")
            var s = this.id.split("/")
            if (!backup && s[s.length-2] == a[a.length-2] && s[1] == a[1]) backup = this.id
            if (!backup2 && s[1] == a[1]) backup2 = this.id
            a.shift()
            a = a.join("/")
            s.shift()
            s = s.join("/")
            if (a == s) match = this.id
          })

        if (!match) {
          if (backup) match = backup
          else if (backup2) match = backup2
          else match = options[0][0].id
        }

        app.start(match)
      }

    }

    builder.url = function() {

      var doc_title = app.build.app.name+" : "+app.build.title
      dataviva.url("/apps/embed/"+app.url,app.vars,doc_title)

    }

    builder.key = function(cats) {

      if ("geo_map" != app.build.app.type) {
        if (!cats) {
          if (app.build.app.type != "network") {
            if (app.data[app.build.data_url].categories) {
              if (app.build.app.type != "stacked") {
                app.categories = app.data[app.build.data_url].categories[app.vars.year]
              }
              else {
                app.categories = app.data[app.build.data_url].categories.all
              }
            }
            else {
              app.categories = []
            }
          }
          else {
            app.categories = []
            app.networks[app.build.output].nodes.forEach(function(n){
              var id = n[app.build.output+"_id"].slice(0,depths[app.build.output][0])
              if (app.categories.indexOf(id) < 0) app.categories.push(id)
            })
          }
        }
        else {
          app.categories = cats
        }

        if (!app.categories) app.categories = []

        if (app.categories.length <= 1) {
          d3.select("div#key").style("display","none")
        }
        else {
          d3.select("div#key").style("display","inline-block")

          d3.selectAll("div.key_icon_container")
            .style("display",function(){
              var id = this.id.slice(3)
              return app.categories.indexOf(id) < 0 ? "none" : "inline-block";
            })
        }

      }

    }

    builder.controls = function() {

      if (app.vars.controls == "false") {
        app.vars.controls = "true"
      } else {
        app.vars.controls = "false"
      }
      builder.url()
      dataviva.resize()

    }

    builder.selector = function(id) {

      if (id == "output") {

        dataviva.popover.show("#output_"+app.build.app.type)

      }
      else if (id == "help") {

        var pid = "#help_"+app.build.app.type

        if (d3.select(pid).empty()) {

          dataviva.popover.create({
            "id": "help_"+app.build.app.type,
            "width": "80%",
            "height": "90%",
            "color": app.build.app.color,
            "close": true
          })

          d3.select(pid).append("iframe")
            .attr("width","100%")
            .attr("height","100%")
            .attr("src","/apps/info/"+app.build.app.type+"/")

        }

        dataviva.popover.show(pid)

      }
      else if (id == "share") {

        var pid = "#share_info"

        if (d3.select(pid).empty()) {

          dataviva.popover.create({
            "id": "share_info",
            "width": "40%",
            "height": "250px",
            "color": app.build.app.color,
            "close": true
          })

          if(same_origin && window.location != window.parent.location){
            var url = encodeURIComponent(window.parent.location.pathname + window.parent.location.search)
          }
          else {
            var url = encodeURIComponent(window.location.pathname + window.location.search)
          }

          d3.json("/apps/shorten/")
            .header("Content-type","application/x-www-form-urlencoded")
            .post("url="+url, function(error,data) {
              if (data.error) {
                alert(data.error)
              }
              else{

                d3.select(pid).append("h3")
                  .text(dataviva.format.text("share_url"))

                // make input box with share link
                var share_url = window.location.origin + "/" + data.slug + "/";
                d3.select(pid).append("input")
                  .attr("type", "text")
                  .attr("class", "leon textbox mediumleon textbox large")
                  .attr("value", share_url)
                  .on(d3plus.client.pointer.click, function(){
                    this.focus();
                    this.select();
                  })

                d3.select(pid).append("h3")
                  .text(dataviva.format.text("embed_url"))

                // make input box with embed iframe
                d3.select(pid).append("input")
                  .attr("type", "text")
                  .attr("class", "leon textbox mediumleon textbox large")
                  .attr("value", "<iframe width='560' height='315' src='"+window.location.href+"' frameborder='0'></iframe>")
                  .on(d3plus.client.pointer.click, function(){
                    this.focus();
                    this.select();
                  })

                d3.select(pid).append("h3")
                  .text(dataviva.format.text("social_media"))

                // Twitter link
                var share_url = window.location.origin + "/" + data.slug
                d3.select(pid).append("a")
                  .attr("href", "https://twitter.com/share?url="+share_url+"&text="+app.viz.title()+"&hashtags=dataviva")
                  .attr("class", "share_button")
                  .attr("target", "_blank")
                  .attr("onclick", "return !window.open(this.href, 'Twitter', 'width=640,height=300')")
                  .attr("id", "Twitter")
                  .attr("title", function(){
                    return dataviva.language == "pt" ? "Tweetar" : "Tweet";
                  })

                // Facebook link
                var description = "{{ _('DataViva is opening up data for the entire formal sector of the Brazilian economy') }}"
                description += " "
                description += "{{ _('through more than 100 million interactive visualizations.') }}"
                d3.select(pid).append("a")
                  .attr("href", "http://www.facebook.com/dialog/feed?display=popup&app_id={{facebook_id}}&description="+description+"&name="+app.viz.title()+"&link="+share_url+"/&picture="+window.location.origin+"/static/img/icons/DataViva.png&redirect_uri="+window.location.origin+"/close/")
                  .attr("class", "share_button")
                  .attr("target", "_blank")
                  .attr("onclick", "return !window.open(this.href, 'Facebook', 'width=640,height=300')")
                  .attr("id", "Facebook")
                  .attr("title", "Facebook")

                // Google link
                d3.select(pid).append("a")
                  .attr("href", function(){
                    var lang = dataviva.language == "pt" ? "pt-BR" : "en-US";
                    return "https://plus.google.com/share?url=" + share_url + "&hl=" + lang
                  })
                  .attr("class", "share_button")
                  .attr("target", "_blank")
                  .attr("onclick", "return !window.open(this.href, 'Google+', 'width=640,height=300')")
                  .attr("id", "Google")
                  .attr("title", "Google+")

              }
            })

        }

        dataviva.popover.show(pid)

      }
      else {

        var s = id.split("_")
        var type = s[0]
        if (s[1]) var index = s[1]

        if (type == "file") {
          var init = "all",
              callback = app.download,
              dist = 0
        }
        else {
          var init = app.build[type][index].id,
              callback = builder.filter

          if (type == "bra" && app.build.bra[index].distance) {
            var dist = app.build.bra[index].distance
          }
          else {
            var dist = 0
          }

        }

        selector
          .callback(callback)
          .distance(dist)
          .initial_value(init)
          .type(id)

        d3.select("#popover")
          .call(selector);

        // Show popover
        dataviva.popover.show("#popover");

      }

    }

    /*****************/
    /* Page Resizing */
    /*****************/

    dataviva.resize = function(noDraw) {

      var children = d3.select("#ui_bottom").node().childNodes,
          min_width = 300;

      if (window.innerWidth < min_width || window.innerHeight <= 400) {
        app.vars.controls = "false";
        d3.select("#ui_bottom").style("display","none")
        d3.select("#settings").style("display","none")
        d3.select("#builder").style("display","none")
      }
      else {
        d3.select("#ui_bottom").style("display","block")
        d3.select("#settings").style("display","block")
        d3.select("#builder").style("display","block")
      }

      // Set the max-width for the builder div and app_title
      d3.select("#builder").style("max-width",window.innerWidth+"px")
      app.title_width = window.innerWidth
      app.title_width -= (d3.select("#settings").node().offsetWidth*2)

      d3.selectAll("#builder > br").remove()
      d3.selectAll("#app_controls > br").remove()

      var total_width = 0,
          settings_width = d3.select("#settings").node().offsetWidth,
          builder_width = d3.select("#app_controls").node().offsetLeft,
          avail_width = window.innerWidth - settings_width - builder_width

      d3.selectAll("#app_controls > div")
        .each(function(){
          total_width += this.offsetWidth
        })

      if (total_width > avail_width) {
        avail_width = window.innerWidth
        firstbreak = false
        var br = document.createElement("br")
        document.getElementById("builder").insertBefore(br,document.getElementById("app_controls"))
      }

      if (total_width > avail_width) {

        var w = 0

        d3.selectAll("#app_controls > div")
          .each(function(){
            if (w > avail_width/2) {
              w = 0
              var br = document.createElement("br")
              this.parentNode.insertBefore(br,this)
            }
            w += this.offsetWidth
          })
      }

      if (app.vars.controls == "true") {
        app.title_width = window.innerWidth
        d3.select("#controls_toggle").attr("class","leon button square active")
        app.title_height = 0
        var buffer = 0
      }
      else {
        app.title_width = window.innerWidth - d3.select("#settings").node().offsetWidth*2
        d3.select("#controls_toggle").attr("class","leon button square")
        if (app.title_width < 200) {
          app.title_width = window.innerWidth
          var buffer = d3.select("#settings").node().offsetHeight
        }
        else {
          var buffer = 0
        }
      }

      if (d3.select("#key").node() && app.categories && app.categories.length > 1) {
        d3.select("#key").style("display","inline-block")
        if (window.innerWidth < d3.select("#key").node().offsetWidth-10) {
          d3.select("#key").style("display","none")
        }
      }

      if (d3.select("#year_slider").node()) {
        d3.select("#year_slider").style("display","inline-block")
        if (window.innerWidth < d3.select("#year_slider").node().offsetWidth-10) {
          d3.select("#year_slider").style("display","none")
        }
      }

      app.height = window.innerHeight
      app.height -= (d3.select("#ui_bottom").node().offsetHeight+buffer)
      if (app.vars.controls != "false") app.height -= d3.select("#builder").node().offsetHeight
      app.width = window.innerWidth-10;

      d3.select("#builder").style("top",function(d){
        if (app.vars.controls != "false") var u = 0
        else var u = 1
        return "-"+((this.offsetHeight+5)*u)+"px"
      })

      d3.select("#app")
        .style("height",app.height+"px")
        .style("width",app.width+"px")
        .style("top",function(d){
          if (app.vars.controls != "false") var u = 1
          else var u = 0

          return (((d3.select("#builder").node().offsetHeight)*u)+buffer)+"px"
        })
        // .call(app.viz
        //     .height(app.height)
        //     .width(app.width)
        //     .title_width(app.title_width)
        //     .title_height(app.title_height)
        //   )

      app.viz
        .height(app.height)
        .width(app.width)
        .title({
          "height": app.title_height,
          "width": app.title_width
        })

      if (!noDraw) {
        app.viz.draw()
      }

      if (!app.first_load) {
        d3.select("#app")
          .style("-webkit-transition","top 0.6s, height 0.6s")
          .style("transition","top 0.6s, height 0.6s")
        d3.select("#builder")
          .style("-webkit-transition","top 0.6s")
          .style("transition","top 0.6s")
      }

    }

    /************************/
    /* Initialize First App */
    /************************/
   app.start()

   if (Modernizr.history) {
     window.onpopstate = function() {
       if (app.first_load) {
         var u = window.location.href.split("/embed/")[1].split("/?")[0]
         u = u.replace(/\/+$/, "")+"/"
         if (u != app.url) app.start(u)
       }
     }
   }

  </script>

{% endblock %}
